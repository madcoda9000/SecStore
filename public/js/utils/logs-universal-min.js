let currentPage=1,messages={},config={};function initializeLogPage(){loadMessages(),loadConfig(),setupEventListeners(),setupNetworkMonitoring(),config.autoFetch&&fetchLogs()}function loadMessages(){const e=document.getElementById("log-messages");messages=e?{msg4:e.dataset.msg4||"Page",msg5:e.dataset.msg5||"of",msg6:e.dataset.msg6||"Error loading logs"}:{msg4:"Page",msg5:"of",msg6:"Error loading logs"}}function loadConfig(){const e=document.getElementById("log-config");config=e?{type:e.dataset.type||"unknown",fetchUrl:e.dataset.fetchUrl||"/admin/logs/fetch",autoFetch:"true"===e.dataset.autoFetch}:{type:"unknown",fetchUrl:"/admin/logs/fetch",autoFetch:!0}}function setupEventListeners(){const e=document.getElementById("search"),t=document.getElementById("pageSize");e&&e.addEventListener("input",debounce(fetchLogs,300)),t&&t.addEventListener("change",(function(){currentPage=1,fetchLogs()})),setupPaginationEventDelegation()}function setupPaginationEventDelegation(){const e=document.getElementById("pagination");e&&e.addEventListener("click",(function(e){if(e.preventDefault(),"A"===e.target.tagName&&e.target.hasAttribute("data-page")){const t=parseInt(e.target.getAttribute("data-page"));!isNaN(t)&&t>0&&goToPage(t)}}))}function fetchLogs(){const e=document.getElementById("search")?.value||"",t=document.getElementById("pageSize")?.value||10,n=document.getElementById("logTableBody"),o=document.getElementById("logCardsBody");if(!config.fetchUrl)return void showError("Configuration error: Fetch URL not found","config");showLoading(!0),n&&(n.innerHTML=""),o&&(o.innerHTML="");const a=`${config.fetchUrl}?search=${encodeURIComponent(e)}&pageSize=${t}&page=${currentPage}`,s={method:"GET",headers:{Accept:"application/json","Cache-Control":"no-cache"},signal:AbortSignal.timeout?AbortSignal.timeout(1e4):void 0};fetch(a,s).then((e=>e.ok?e.json():handleHTTPError(e))).then((e=>{if(!e.logs||!Array.isArray(e.logs))throw new Error("Invalid API response format");populateTable(e.logs),populateCards(e.logs),updatePagination(e.page||1,e.totalPages||1),clearErrorState()})).catch((e=>{handleFetchError(e)})).finally((()=>{showLoading(!1)}))}function handleHTTPError(e){const t={401:()=>{showError("Session expired. Please log in again.","auth",{action:"login",actionText:"Go to Login",actionHandler:()=>window.location.href="/login"})},403:()=>{showError("Access denied. You don't have permission to view these logs.","permission")},404:()=>{showError("Log endpoint not found. Please check the configuration.","config")},429:()=>{showError("Too many requests. Please wait a moment and try again.","rate-limit",{retryAfter:parseInt(e.headers.get("Retry-After")||"60")})},500:()=>{showError("Server error. Please try again later.","server",{action:"retry",actionText:"Retry",actionHandler:()=>fetchLogs()})},default:()=>{showError(`HTTP Error ${e.status}: ${e.statusText}`,"http",{action:"retry",actionText:"Retry",actionHandler:()=>fetchLogs()})}};throw(t[e.status]||t.default)(),new Error(`HTTP ${e.status}: ${e.statusText}`)}function handleFetchError(e){"AbortError"===e.name?showError("Request timed out. Please check your internet connection.","timeout",{action:"retry",actionText:"Retry",actionHandler:()=>fetchLogs()}):e.message.includes("Failed to fetch")||!navigator.onLine?showError("Network error. Please check your internet connection.","network",{action:"retry",actionText:"Retry Now",actionHandler:()=>{setTimeout(fetchLogs,1e3)}}):e.message.includes("Invalid API response")?showError("Server returned invalid data. Please refresh the page.","data",{action:"refresh",actionText:"Refresh Page",actionHandler:()=>window.location.reload()}):showError(e.message||messages.msg6||"Error loading logs","unknown",{action:"retry",actionText:"Try Again",actionHandler:()=>fetchLogs()})}function populateTable(e){const t=document.getElementById("logTableBody");t&&(t.innerHTML="",0!==e.length?e.forEach((e=>{const n=document.createElement("tr");n.innerHTML=`\n            <td>${escapeHtml(e.id||"")}</td>\n            <td><span class="badge bg-secondary">${escapeHtml(e.type||"")}</span></td>\n            <td>${escapeHtml(e.datum_zeit||"")}</td>\n            <td>${escapeHtml(e.user||"")}</td>\n            <td>${escapeHtml(e.context||"")}</td>\n            <td>${escapeHtml(e.message||"")}</td>\n        `,t.appendChild(n)})):t.innerHTML='\n            <tr>\n                <td colspan="6" class="text-center text-muted py-4">\n                    <i class="bi bi-info-circle"></i> No logs found\n                </td>\n            </tr>\n        ')}function populateCards(e){const t=document.getElementById("logCardsBody");t&&(t.innerHTML="",0!==e.length?e.forEach(((e,n)=>{const o=createMobileLogCard(e,n);t.appendChild(o)})):t.innerHTML='\n            <div class="alert alert-info text-center py-4">\n                <i class="bi bi-info-circle" style="font-size: 2rem; margin-bottom: 0.5rem; display: block;"></i>\n                <strong>No logs found</strong>\n                <p class="mb-0 text-muted small">Try adjusting your search criteria</p>\n            </div>\n        ')}function createMobileLogCard(e,t){const n=document.createElement("div"),o=`log-card-${t}`,a={AUDIT:{bg:"bg-primary",text:"text-primary",border:"border-primary"},SECURITY:{bg:"bg-danger",text:"text-danger",border:"border-danger"},ERROR:{bg:"bg-warning",text:"text-warning",border:"border-warning"},SYSTEM:{bg:"bg-info",text:"text-info",border:"border-info"},SQL:{bg:"bg-success",text:"text-success",border:"border-success"},MAIL:{bg:"bg-secondary",text:"text-secondary",border:"border-secondary"},REQUEST:{bg:"bg-dark",text:"text-dark",border:"border-dark"}},s=a[(e.type||"").toUpperCase()]||a.SYSTEM,r=e.message||"",i=r.length>100,c=i?r.substring(0,100)+"...":r,l=formatMobileDate(e.datum_zeit);return n.className=`card mb-3 shadow-sm log-mobile-card ${s.border} border-start border-3`,n.style.cssText="\n        border-radius: 12px;\n        transition: all 0.2s ease;\n        cursor: pointer;\n        min-height: 140px;\n    ",n.innerHTML=`\n        <div class="card-body p-3">\n            \x3c!-- Header Row --\x3e\n            <div class="d-flex justify-content-between align-items-start mb-2">\n                <div class="d-flex align-items-center">\n                    <span class="badge ${s.bg} badge-lg me-2 px-2 py-1">\n                        ${escapeHtml(e.type||"UNKNOWN")}\n                    </span>\n                    <small class="text-muted fw-bold">#${escapeHtml(e.id||"")}</small>\n                </div>\n                <div class="text-end">\n                    <div class="text-muted small">${l.time}</div>\n                    <div class="text-muted x-small">${l.date}</div>\n                </div>\n            </div>\n            \n            \x3c!-- User & Context Row --\x3e\n            <div class="row g-2 mb-2">\n                <div class="col-6">\n                    <div class="text-muted x-small">User</div>\n                    <div class="fw-medium small text-truncate" title="${escapeHtml(e.user||"N/A")}">\n                        <i class="bi bi-person-circle me-1"></i>${escapeHtml(e.user||"System")}\n                    </div>\n                </div>\n                <div class="col-6">\n                    <div class="text-muted x-small">Context</div>\n                    <div class="fw-medium small text-truncate" title="${escapeHtml(e.context||"N/A")}">\n                        <i class="bi bi-gear-wide me-1"></i>${escapeHtml(e.context||"General")}\n                    </div>\n                </div>\n            </div>\n            \n            \x3c!-- Message Section --\x3e\n            <div class="message-section">\n                <div class="text-muted x-small mb-1">Message</div>\n                <div class="message-content small">\n                    <span class="message-preview">${escapeHtml(c)}</span>\n                    ${i?`\n                        <span class="message-full d-none">${escapeHtml(r)}</span>\n                        <button class="btn btn-link btn-sm p-0 ms-1 expand-btn ${s.text}" \n                                type="button" onclick="toggleMessage('${o}')">\n                            <i class="bi bi-chevron-down expand-icon"></i>\n                        </button>\n                    `:""}\n                </div>\n            </div>\n            \n            \x3c!-- Touch Actions --\x3e\n            <div class="card-actions mt-2 pt-2 border-top d-none">\n                <div class="d-flex justify-content-end gap-2">\n                    <button class="btn btn-outline-primary btn-sm" onclick="copyLogEntry('${o}')">\n                        <i class="bi bi-clipboard"></i> Copy\n                    </button>\n                    <button class="btn btn-outline-secondary btn-sm" onclick="shareLogEntry('${o}')">\n                        <i class="bi bi-share"></i> Share\n                    </button>\n                </div>\n            </div>\n        </div>\n    `,setupCardInteractions(n,o),n}function formatMobileDate(e){if(!e)return{date:"N/A",time:"N/A"};try{const t=new Date(e),n=new Date,o=Math.floor((n-t)/864e5);let a;a=0===o?"Today":1===o?"Yesterday":o<7?`${o} days ago`:t.toLocaleDateString();return{date:a,time:t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}}catch(t){return{date:e.split(" ")[0]||"N/A",time:e.split(" ")[1]||"N/A"}}}function setupCardInteractions(e,t){let n=0,o=0;e.addEventListener("mouseenter",(()=>{e.style.transform="translateY(-2px)",e.style.boxShadow="0 4px 12px rgba(0,0,0,0.15)"})),e.addEventListener("mouseleave",(()=>{e.style.transform="translateY(0)",e.style.boxShadow=""})),e.addEventListener("touchstart",(t=>{n=t.touches[0].clientY,o=Date.now(),e.style.transform="scale(0.98)"}),{passive:!0}),e.addEventListener("touchend",(a=>{const s=a.changedTouches[0].clientY,r=Date.now()-o,i=Math.abs(s-n);e.style.transform="",r<300&&i<10&&toggleCardActions(t),i>50&&s<n-30&&r<500&&expandCard(t),i>50&&s>n+30&&r<500&&collapseCard(t)}),{passive:!0}),e.addEventListener("contextmenu",(e=>{e.preventDefault()}))}function toggleMessage(e){const t=document.querySelector(`[id="${e}"], .log-mobile-card:nth-child(${e.split("-").pop()- -1})`);if(!t)return;const n=t.querySelector(".message-preview"),o=t.querySelector(".message-full"),a=t.querySelector(".expand-icon");if(!n||!o||!a)return;!o.classList.contains("d-none")?(o.classList.add("d-none"),n.classList.remove("d-none"),a.classList.remove("bi-chevron-up"),a.classList.add("bi-chevron-down")):(o.classList.remove("d-none"),n.classList.add("d-none"),a.classList.remove("bi-chevron-down"),a.classList.add("bi-chevron-up"))}function toggleCardActions(e){const t=document.querySelector(`[id="${e}"], .log-mobile-card:nth-child(${e.split("-").pop()- -1})`);if(!t)return;const n=t.querySelector(".card-actions");if(!n)return;const o=!n.classList.contains("d-none");document.querySelectorAll(".card-actions").forEach((e=>{e.classList.add("d-none")})),o?(n.classList.add("d-none"),t.style.backgroundColor=""):(n.classList.remove("d-none"),t.style.backgroundColor="var(--bs-gray-50)")}function expandCard(e){const t=document.querySelector(`[id="${e}"], .log-mobile-card:nth-child(${e.split("-").pop()- -1})`);if(!t)return;t.querySelector(".expand-btn")&&toggleMessage(e),toggleCardActions(e)}function collapseCard(e){const t=document.querySelector(`[id="${e}"], .log-mobile-card:nth-child(${e.split("-").pop()- -1})`);if(!t)return;const n=t.querySelector(".message-full");n&&!n.classList.contains("d-none")&&toggleMessage(e);const o=t.querySelector(".card-actions");o&&(o.classList.add("d-none"),t.style.backgroundColor="")}function copyLogEntry(e){const t=document.querySelector(`[id="${e}"], .log-mobile-card:nth-child(${e.split("-").pop()- -1})`);if(!t)return;const n=t.querySelector(".badge").nextElementSibling?.textContent||"",o=t.querySelector(".badge").textContent,a=t.querySelector(".message-full")?.textContent||t.querySelector(".message-preview").textContent,s=`Log Entry ${n}\nType: ${o}\nUser: ${t.querySelector('[title*="User"], .bi-person-circle').parentElement.textContent.replace("👤","").trim()}\nMessage: ${a}`;navigator.clipboard.writeText(s).then((()=>{showSuccessMessage("Log entry copied to clipboard")})).catch((()=>{const e=document.createElement("textarea");e.value=s,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e),showSuccessMessage("Log entry copied to clipboard")}))}function shareLogEntry(e){const t=document.querySelector(`[id="${e}"], .log-mobile-card:nth-child(${e.split("-").pop()- -1})`);if(!t)return;const n={title:`Log Entry ${t.querySelector(".badge").nextElementSibling?.textContent||""}`,text:`${t.querySelector(".badge").textContent}: ${t.querySelector(".message-full")?.textContent||t.querySelector(".message-preview").textContent}`,url:window.location.href};navigator.share?navigator.share(n).catch((e=>{})):copyLogEntry(e)}function updatePagination(e,t){const n=document.getElementById("pagination"),o=document.getElementById("paginationInfo");if(!n)return;if(n.innerHTML="",o&&(o.textContent=`${messages.msg4} ${e} ${messages.msg5} ${t}`),t<=1)return;const a=Math.max(1,e-Math.floor(2.5)),s=Math.min(t,a+5-1);if(e>1){const t=document.createElement("li");t.className="page-item",t.innerHTML=`<a class="page-link" href="#" data-page="${e-1}" title="Previous Page">&laquo;</a>`,n.appendChild(t)}if(a>1){const e=document.createElement("li");if(e.className="page-item",e.innerHTML='<a class="page-link" href="#" data-page="1">1</a>',n.appendChild(e),a>2){const e=document.createElement("li");e.className="page-item disabled",e.innerHTML='<span class="page-link">...</span>',n.appendChild(e)}}for(let t=a;t<=s;t++){const o=document.createElement("li");o.className="page-item "+(t===e?"active":""),o.innerHTML=`<a class="page-link" href="#" data-page="${t}">${t}</a>`,n.appendChild(o)}if(s<t){if(s<t-1){const e=document.createElement("li");e.className="page-item disabled",e.innerHTML='<span class="page-link">...</span>',n.appendChild(e)}const e=document.createElement("li");e.className="page-item",e.innerHTML=`<a class="page-link" href="#" data-page="${t}">${t}</a>`,n.appendChild(e)}if(e<t){const t=document.createElement("li");t.className="page-item",t.innerHTML=`<a class="page-link" href="#" data-page="${e+1}" title="Next Page">&raquo;</a>`,n.appendChild(t)}}function goToPage(e){e&&e>0&&(currentPage=e,fetchLogs(),window.scrollTo({top:0,behavior:"smooth"}))}function showLoading(e){const t=document.getElementById("loadingSpinner");t&&(t.style.display=e?"block":"none")}function showError(e,t="general",n={}){const o=document.getElementById("logTableBody"),a=document.getElementById("logCardsBody"),s={config:"bi-gear-fill",auth:"bi-lock-fill",permission:"bi-shield-x","rate-limit":"bi-hourglass-split",server:"bi-server",network:"bi-wifi-off",timeout:"bi-clock-history",data:"bi-file-earmark-excel",general:"bi-exclamation-triangle"},r=s[t]||s.general;let i="";if(n.action&&n.actionText&&n.actionHandler){const e="error-action-"+Math.random().toString(36).substr(2,9);i=`\n            <button id="${e}" class="btn btn-outline-primary btn-sm mt-2">\n                <i class="bi bi-arrow-clockwise"></i> ${n.actionText}\n            </button>\n        `,setTimeout((()=>{const t=document.getElementById(e);t&&n.actionHandler&&t.addEventListener("click",n.actionHandler)}),10)}const c=`\n        <div class="text-center text-danger py-5">\n            <i class="bi ${r}" style="font-size: 3rem; margin-bottom: 1rem;"></i>\n            <h5>Oops! Something went wrong</h5>\n            <p class="text-muted">${escapeHtml(e)}</p>\n            ${i}\n            <div class="mt-3">\n                <small class="text-muted">\n                    Error Code: ${t.toUpperCase()} | Time: ${(new Date).toLocaleTimeString()}\n                </small>\n            </div>\n        </div>\n    `;o&&(o.innerHTML=`<tr><td colspan="6">${c}</td></tr>`),a&&(a.innerHTML=`<div class="alert alert-danger">${c}</div>`),"rate-limit"===t&&n.retryAfter&&startRetryCountdown(n.retryAfter)}function clearErrorState(){document.querySelectorAll('[id^="error-action-"]').forEach((e=>e.remove()))}function startRetryCountdown(e){let t=e;const n=setInterval((()=>{t--;const e=document.querySelector(".rate-limit-countdown");e&&(e.textContent=t),t<=0&&(clearInterval(n),fetchLogs())}),1e3)}function escapeHtml(e){if("string"!=typeof e)return e||"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}function debounce(e,t){let n;return function(...o){clearTimeout(n),n=setTimeout((()=>{clearTimeout(n),e(...o)}),t)}}function setupNetworkMonitoring(){window.addEventListener("online",(()=>{showSuccessMessage("Connection restored. Refreshing logs..."),setTimeout(fetchLogs,500)})),window.addEventListener("offline",(()=>{showError("You appear to be offline. Please check your internet connection.","network")}))}function showSuccessMessage(e){const t=document.createElement("div");t.className="alert alert-success alert-dismissible fade show position-fixed",t.style.cssText="\n        top: 20px;\n        right: 20px;\n        z-index: 9999;\n        min-width: 300px;\n        max-width: 500px;\n    ",t.innerHTML=`\n        <i class="bi bi-check-circle"></i> ${e}\n        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>\n    `,document.body.appendChild(t),setTimeout((()=>{t.parentElement&&t.remove()}),5e3)}document.addEventListener("DOMContentLoaded",(function(){initializeLogPage()})),window.toggleMessage=toggleMessage,window.copyLogEntry=copyLogEntry,window.shareLogEntry=shareLogEntry,window.goToPage=goToPage,window.fetchLogs=fetchLogs;