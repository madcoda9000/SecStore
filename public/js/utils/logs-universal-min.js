let currentPage=1,messages={},config={};function initializeLogPage(){loadMessages(),loadConfig(),setupEventListeners(),setupNetworkMonitoring(),config.autoFetch&&fetchLogs()}function loadMessages(){const e=document.getElementById("log-messages");messages=e?{msg4:e.dataset.msg4||"Page",msg5:e.dataset.msg5||"of",msg6:e.dataset.msg6||"Error loading logs"}:{msg4:"Page",msg5:"of",msg6:"Error loading logs"}}function loadConfig(){const e=document.getElementById("log-config");config=e?{type:e.dataset.type||"unknown",fetchUrl:e.dataset.fetchUrl||"/admin/logs/fetch",autoFetch:"true"===e.dataset.autoFetch}:{type:"unknown",fetchUrl:"/admin/logs/fetch",autoFetch:!0}}function setupEventListeners(){const e=document.getElementById("search"),t=document.getElementById("pageSize");e&&e.addEventListener("input",debounce(fetchLogs,300)),t&&t.addEventListener("change",(function(){currentPage=1,fetchLogs()})),setupPaginationEventDelegation()}function setupPaginationEventDelegation(){const e=document.getElementById("pagination");e&&e.addEventListener("click",(function(e){if(e.preventDefault(),"A"===e.target.tagName&&e.target.hasAttribute("data-page")){const t=parseInt(e.target.getAttribute("data-page"));!isNaN(t)&&t>0&&goToPage(t)}}))}function fetchLogs(){const e=document.getElementById("search")?.value||"",t=document.getElementById("pageSize")?.value||10,n=document.getElementById("logTableBody"),o=document.getElementById("logCardsBody");if(!config.fetchUrl)return void showError("Configuration error: Fetch URL not found","config");showLoading(!0),n&&(n.innerHTML=""),o&&(o.innerHTML="");const a=`${config.fetchUrl}?search=${encodeURIComponent(e)}&pageSize=${t}&page=${currentPage}`,r={method:"GET",headers:{Accept:"application/json","Cache-Control":"no-cache"},signal:AbortSignal.timeout?AbortSignal.timeout(1e4):void 0};fetch(a,r).then((e=>e.ok?e.json():handleHTTPError(e))).then((e=>{if(!e.logs||!Array.isArray(e.logs))throw new Error("Invalid API response format");populateTable(e.logs),populateCards(e.logs),updatePagination(e.page||1,e.totalPages||1),clearErrorState()})).catch((e=>{handleFetchError(e)})).finally((()=>{showLoading(!1)}))}function handleHTTPError(e){const t={401:()=>{showError("Session expired. Please log in again.","auth",{action:"login",actionText:"Go to Login",actionHandler:()=>window.location.href="/login"})},403:()=>{showError("Access denied. You don't have permission to view these logs.","permission")},404:()=>{showError("Log endpoint not found. Please check the configuration.","config")},429:()=>{showError("Too many requests. Please wait a moment and try again.","rate-limit",{retryAfter:parseInt(e.headers.get("Retry-After")||"60")})},500:()=>{showError("Server error. Please try again later.","server",{action:"retry",actionText:"Retry",actionHandler:()=>fetchLogs()})},default:()=>{showError(`HTTP Error ${e.status}: ${e.statusText}`,"http",{action:"retry",actionText:"Retry",actionHandler:()=>fetchLogs()})}};throw(t[e.status]||t.default)(),new Error(`HTTP ${e.status}: ${e.statusText}`)}function handleFetchError(e){"AbortError"===e.name?showError("Request timed out. Please check your internet connection.","timeout",{action:"retry",actionText:"Retry",actionHandler:()=>fetchLogs()}):e.message.includes("Failed to fetch")||!navigator.onLine?showError("Network error. Please check your internet connection.","network",{action:"retry",actionText:"Retry Now",actionHandler:()=>{setTimeout(fetchLogs,1e3)}}):e.message.includes("Invalid API response")?showError("Server returned invalid data. Please refresh the page.","data",{action:"refresh",actionText:"Refresh Page",actionHandler:()=>window.location.reload()}):showError(e.message||messages.msg6||"Error loading logs","unknown",{action:"retry",actionText:"Try Again",actionHandler:()=>fetchLogs()})}function populateTable(e){const t=document.getElementById("logTableBody");t&&(t.innerHTML="",0!==e.length?e.forEach((e=>{const n=document.createElement("tr");n.innerHTML=`\n            <td>${escapeHtml(e.id||"")}</td>\n            <td><span class="badge bg-secondary">${escapeHtml(e.type||"")}</span></td>\n            <td>${escapeHtml(e.datum_zeit||"")}</td>\n            <td>${escapeHtml(e.user||"")}</td>\n            <td>${escapeHtml(e.context||"")}</td>\n            <td>${escapeHtml(e.message||"")}</td>\n        `,t.appendChild(n)})):t.innerHTML='\n            <tr>\n                <td colspan="6" class="text-center text-muted py-4">\n                    <i class="bi bi-info-circle"></i> No logs found\n                </td>\n            </tr>\n        ')}function populateCards(e){const t=document.getElementById("logCardsBody");t&&(t.innerHTML="",0!==e.length?e.forEach((e=>{const n=document.createElement("div");n.className="card mb-2 p-2",n.innerHTML=`\n            <div><strong>#${escapeHtml(e.id||"")}</strong></div>\n            <div><strong>Type:</strong> <span class="badge bg-secondary">${escapeHtml(e.type||"")}</span></div>\n            <div><strong>Date:</strong> ${escapeHtml(e.datum_zeit||"")}</div>\n            <div><strong>User:</strong> ${escapeHtml(e.user||"")}</div>\n            <div><strong>Context:</strong> ${escapeHtml(e.context||"")}</div>\n            <div><strong>Message:</strong> ${escapeHtml(e.message||"")}</div>\n        `,t.appendChild(n)})):t.innerHTML='\n            <div class="alert alert-info">\n                <i class="bi bi-info-circle"></i> No logs found\n            </div>\n        ')}function updatePagination(e,t){const n=document.getElementById("pagination"),o=document.getElementById("paginationInfo");if(!n)return;if(n.innerHTML="",o&&(o.textContent=`${messages.msg4} ${e} ${messages.msg5} ${t}`),t<=1)return;const a=Math.max(1,e-Math.floor(2.5)),r=Math.min(t,a+5-1);if(e>1){const t=document.createElement("li");t.className="page-item",t.innerHTML=`<a class="page-link" href="#" data-page="${e-1}" title="Previous Page">&laquo;</a>`,n.appendChild(t)}if(a>1){const e=document.createElement("li");if(e.className="page-item",e.innerHTML='<a class="page-link" href="#" data-page="1">1</a>',n.appendChild(e),a>2){const e=document.createElement("li");e.className="page-item disabled",e.innerHTML='<span class="page-link">...</span>',n.appendChild(e)}}for(let t=a;t<=r;t++){const o=document.createElement("li");o.className="page-item "+(t===e?"active":""),o.innerHTML=`<a class="page-link" href="#" data-page="${t}">${t}</a>`,n.appendChild(o)}if(r<t){if(r<t-1){const e=document.createElement("li");e.className="page-item disabled",e.innerHTML='<span class="page-link">...</span>',n.appendChild(e)}const e=document.createElement("li");e.className="page-item",e.innerHTML=`<a class="page-link" href="#" data-page="${t}">${t}</a>`,n.appendChild(e)}if(e<t){const t=document.createElement("li");t.className="page-item",t.innerHTML=`<a class="page-link" href="#" data-page="${e+1}" title="Next Page">&raquo;</a>`,n.appendChild(t)}}function goToPage(e){e&&e>0&&(currentPage=e,fetchLogs(),window.scrollTo({top:0,behavior:"smooth"}))}function showLoading(e){const t=document.getElementById("loadingSpinner");t&&(t.style.display=e?"block":"none")}function showError(e,t="general",n={}){const o=document.getElementById("logTableBody"),a=document.getElementById("logCardsBody"),r={config:"bi-gear-fill",auth:"bi-lock-fill",permission:"bi-shield-x","rate-limit":"bi-hourglass-split",server:"bi-server",network:"bi-wifi-off",timeout:"bi-clock-history",data:"bi-file-earmark-excel",general:"bi-exclamation-triangle"},i=r[t]||r.general;let s="";if(n.action&&n.actionText&&n.actionHandler){const e="error-action-"+Math.random().toString(36).substr(2,9);s=`\n            <button id="${e}" class="btn btn-outline-primary btn-sm mt-2">\n                <i class="bi bi-arrow-clockwise"></i> ${n.actionText}\n            </button>\n        `,setTimeout((()=>{const t=document.getElementById(e);t&&n.actionHandler&&t.addEventListener("click",n.actionHandler)}),10)}const c=`\n        <div class="text-center text-danger py-5">\n            <i class="bi ${i}" style="font-size: 3rem; margin-bottom: 1rem;"></i>\n            <h5>Oops! Something went wrong</h5>\n            <p class="text-muted">${escapeHtml(e)}</p>\n            ${s}\n            <div class="mt-3">\n                <small class="text-muted">\n                    Error Code: ${t.toUpperCase()} | Time: ${(new Date).toLocaleTimeString()}\n                </small>\n            </div>\n        </div>\n    `;o&&(o.innerHTML=`<tr><td colspan="6">${c}</td></tr>`),a&&(a.innerHTML=`<div class="alert alert-danger">${c}</div>`),"rate-limit"===t&&n.retryAfter&&startRetryCountdown(n.retryAfter)}function clearErrorState(){document.querySelectorAll('[id^="error-action-"]').forEach((e=>e.remove()))}function startRetryCountdown(e){let t=e;const n=setInterval((()=>{t--;const e=document.querySelector(".rate-limit-countdown");e&&(e.textContent=t),t<=0&&(clearInterval(n),fetchLogs())}),1e3)}function escapeHtml(e){if("string"!=typeof e)return e||"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}function debounce(e,t){let n;return function(...o){clearTimeout(n),n=setTimeout((()=>{clearTimeout(n),e(...o)}),t)}}function setupNetworkMonitoring(){window.addEventListener("online",(()=>{showSuccessMessage("Connection restored. Refreshing logs..."),setTimeout(fetchLogs,500)})),window.addEventListener("offline",(()=>{showError("You appear to be offline. Please check your internet connection.","network")}))}function showSuccessMessage(e){const t=document.createElement("div");t.className="alert alert-success alert-dismissible fade show position-fixed",t.style.cssText="\n        top: 20px;\n        right: 20px;\n        z-index: 9999;\n        min-width: 300px;\n        max-width: 500px;\n    ",t.innerHTML=`\n        <i class="bi bi-check-circle"></i> ${e}\n        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>\n    `,document.body.appendChild(t),setTimeout((()=>{t.parentElement&&t.remove()}),5e3)}document.addEventListener("DOMContentLoaded",(function(){initializeLogPage()})),window.goToPage=goToPage,window.fetchLogs=fetchLogs;