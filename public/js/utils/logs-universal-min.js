let currentPage=1,totalPages=1,itemsPerPage=10,searchQuery="";const configEl=document.getElementById("log-config"),logType=configEl?.dataset.type||"system",fetchUrl=configEl?.dataset.fetchUrl||"/admin/logs/fetch",autoFetch="true"===configEl?.dataset.autoFetch,messagesEl=document.getElementById("log-messages"),MSG_PAGE=messagesEl?.dataset.msg4||"Page",MSG_OF=messagesEl?.dataset.msg5||"of",MSG_ERROR=messagesEl?.dataset.msg6||"Error loading logs";function setupEventListeners(){document.addEventListener("click",(function(e){if(e.target.matches(".page-link, .page-link *")){e.preventDefault();const t=e.target.closest(".page-link"),n=parseInt(t?.dataset.page);n&&goToPage(n)}}));const e=document.getElementById("pageSize");e&&e.addEventListener("change",(function(){itemsPerPage=parseInt(this.value),currentPage=1,fetchLogs()}));const t=document.getElementById("search");if(t){let e;t.addEventListener("input",(function(){clearTimeout(e),e=setTimeout((()=>{searchQuery=this.value.trim(),currentPage=1,fetchLogs()}),500)}))}window.addEventListener("online",(()=>{setTimeout(fetchLogs,500)})),window.addEventListener("offline",(()=>{showError("You appear to be offline. Please check your internet connection.","network")}))}function fetchLogs(){showLoading(!0);const e=new URLSearchParams({page:currentPage,itemsPerPage:itemsPerPage,search:searchQuery});fetch(`${fetchUrl}?${e}`).then((e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()})).then((e=>{showLoading(!1),e?(populateTable(e.logs||[]),populateCards(e.logs||[]),totalPages=e.totalPages||1,updatePagination()):showError(e.message||MSG_ERROR)})).catch((e=>{showLoading(!1),showError(MSG_ERROR,"network")}))}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function populateTable(e){const t=document.getElementById("logTableBody");t&&(t.innerHTML="",0!==e.length?e.forEach((e=>{const n=document.createElement("tr");n.innerHTML=`\n      <td>${escapeHtml(e.id||"")}</td>\n      <td><span class="badge bg-secondary">${escapeHtml(e.type||"")}</span></td>\n      <td>${escapeHtml(e.datum_zeit||"")}</td>\n      <td>${escapeHtml(e.user||"")}</td>\n      <td>${escapeHtml(e.context||"")}</td>\n      <td>${escapeHtml(e.message||"")}</td>\n    `,t.appendChild(n)})):t.innerHTML='\n      <tr>\n        <td colspan="6" class="text-center py-5">\n          <div class="no-logs-message">\n            <i class="bi bi-info-circle icon-3rem text-muted"></i>\n            <p class="fw-bold mt-3">No logs found</p>\n            <p class="text-muted small mb-0">Try adjusting your search criteria</p>\n          </div>\n        </td>\n      </tr>\n    ')}function populateCards(e){const t=document.getElementById("logCardsBody");t&&(t.innerHTML="",0!==e.length?e.forEach(((e,n)=>{const a=createMobileLogCard(e,n);t.appendChild(a)})):t.innerHTML='\n      <div class="alert alert-info text-center py-4">\n        <i class="bi bi-info-circle icon-2rem d-block mb-2"></i>\n        <strong>No logs found</strong>\n        <p class="mb-0 text-muted small">Try adjusting your search criteria</p>\n      </div>\n    ')}function createMobileLogCard(e,t){const n=document.createElement("div"),a=`log-card-${t}`,s=(e.type||"").toUpperCase(),i={AUDIT:"log-card-audit",SECURITY:"log-card-security",ERROR:"log-card-error",SYSTEM:"log-card-system",SQL:"log-card-sql",MAILSCHEDULER:"log-card-mail",REQUEST:"log-card-request"}[s]||"log-card-system",o=e.message||"",l=o.length>100,c=l?o.substring(0,100)+"...":o,r=formatMobileDate(e.datum_zeit);return n.className=`card mb-3 shadow-sm log-mobile-card ${i}`,n.innerHTML=`\n    <div class="card-body p-3">\n      \x3c!-- Header Row --\x3e\n      <div class="d-flex justify-content-between align-items-start mb-2">\n        <div class="d-flex align-items-center">\n          <span class="badge log-badge-${s.toLowerCase()} badge-lg me-2 px-2 py-1">\n            ${escapeHtml(e.type||"UNKNOWN")}\n          </span>\n          <small class="text-muted fw-bold">#${escapeHtml(e.id||"")}</small>\n        </div>\n        <div class="text-end">\n          <div class="text-muted small">${r.time}</div>\n          <div class="text-muted x-small">${r.date}</div>\n        </div>\n      </div>\n      \n      \x3c!-- User & Context Row --\x3e\n      <div class="row g-2 mb-2">\n        <div class="col-6">\n          <div class="text-muted x-small">User</div>\n          <div class="fw-medium small text-truncate" title="${escapeHtml(e.user||"N/A")}">\n            <i class="bi bi-person-circle me-1"></i>${escapeHtml(e.user||"System")}\n          </div>\n        </div>\n        <div class="col-6">\n          <div class="text-muted x-small">Context</div>\n          <div class="fw-medium small text-truncate" title="${escapeHtml(e.context||"N/A")}">\n            <i class="bi bi-gear-wide me-1"></i>${escapeHtml(e.context||"General")}\n          </div>\n        </div>\n      </div>\n      \n      \x3c!-- Message Section --\x3e\n      <div class="message-section">\n        <div class="text-muted x-small mb-1">Message</div>\n        <div class="message-content small">\n          <span class="message-preview">${escapeHtml(c)}</span>\n          ${l?`\n            <a href="#" class="text-primary small ms-1 toggle-message" data-card-id="${a}">\n              Show more <i class="bi bi-chevron-down"></i>\n            </a>\n            <span class="message-full d-none">${escapeHtml(o)}</span>\n          `:""}\n        </div>\n      </div>\n    </div>\n  `,l&&setTimeout((()=>{const e=n.querySelector(".toggle-message");e&&e.addEventListener("click",(function(e){e.preventDefault();const t=n.querySelector(".message-preview"),a=n.querySelector(".message-full");this.querySelector("i");a.classList.contains("d-none")?(t.classList.add("d-none"),a.classList.remove("d-none"),this.innerHTML='Show less <i class="bi bi-chevron-up"></i>'):(t.classList.remove("d-none"),a.classList.add("d-none"),this.innerHTML='Show more <i class="bi bi-chevron-down"></i>')}))}),10),n}function formatMobileDate(e){if(!e)return{date:"N/A",time:"N/A"};try{const[t,n]=e.split(" "),[a,s,i]=t.split("-"),[o,l]=n.split(":");return{date:`${i}.${s}.${a}`,time:`${o}:${l}`}}catch(t){return{date:e,time:""}}}function updatePagination(){const e=document.getElementById("pagination");if(!e)return;if(e.innerHTML="",totalPages<=1)return;const t=currentPage,n=totalPages;if(t>1){const n=document.createElement("li");n.className="page-item",n.innerHTML=`<a class="page-link" href="#" data-page="${t-1}" title="Previous Page">&laquo;</a>`,e.appendChild(n)}let a=Math.max(1,t-Math.floor(2.5)),s=Math.min(n,a+5-1);if(s-a<4&&(a=Math.max(1,s-5+1)),a>1){const t=document.createElement("li");if(t.className="page-item",t.innerHTML='<a class="page-link" href="#" data-page="1">1</a>',e.appendChild(t),a>2){const t=document.createElement("li");t.className="page-item disabled",t.innerHTML='<span class="page-link">...</span>',e.appendChild(t)}}for(let n=a;n<=s;n++){const a=document.createElement("li");a.className="page-item "+(n===t?"active":""),a.innerHTML=`<a class="page-link" href="#" data-page="${n}">${n}</a>`,e.appendChild(a)}if(s<n){if(s<n-1){const t=document.createElement("li");t.className="page-item disabled",t.innerHTML='<span class="page-link">...</span>',e.appendChild(t)}const t=document.createElement("li");t.className="page-item",t.innerHTML=`<a class="page-link" href="#" data-page="${n}">${n}</a>`,e.appendChild(t)}if(t<n){const n=document.createElement("li");n.className="page-item",n.innerHTML=`<a class="page-link" href="#" data-page="${t+1}" title="Next Page">&raquo;</a>`,e.appendChild(n)}}function goToPage(e){e&&e>0&&(currentPage=e,fetchLogs(),window.scrollTo({top:0,behavior:"smooth"}))}function showLoading(e){const t=document.getElementById("loadingSpinner");t&&(e?(t.classList.remove("d-none"),t.classList.add("d-block")):(t.classList.remove("d-block"),t.classList.add("d-none")))}function showError(e,t="general",n={}){const a=document.getElementById("logTableBody"),s=document.getElementById("logCardsBody"),i={config:"bi-gear-fill",auth:"bi-lock-fill",permission:"bi-shield-x","rate-limit":"bi-hourglass-split",server:"bi-server",network:"bi-wifi-off",timeout:"bi-clock-history",data:"bi-file-earmark-excel",general:"bi-exclamation-triangle"},o=i[t]||i.general;let l="";if(n.action&&n.actionText&&n.actionHandler){const e="error-action-"+Math.random().toString(36).substr(2,9);l=`\n      <button id="${e}" class="btn btn-outline-primary btn-sm mt-2">\n        <i class="bi bi-arrow-clockwise"></i> ${n.actionText}\n      </button>\n    `,setTimeout((()=>{const t=document.getElementById(e);t&&n.actionHandler&&t.addEventListener("click",n.actionHandler)}),10)}const c=`\n    <div class="text-center text-danger py-5">\n      <i class="bi ${o} icon-3rem mb-3"></i>\n      <h5>Oops! Something went wrong</h5>\n      <p class="text-muted">${escapeHtml(e)}</p>\n      ${l}\n    </div>\n  `;a&&(a.innerHTML=`<tr><td colspan="6">${c}</td></tr>`),s&&(s.innerHTML=c)}function showSuccessMessage(e){const t=document.createElement("div");t.className="alert alert-success alert-dismissible fade show position-fixed toast-notification",t.innerHTML=`\n    <i class="bi bi-check-circle"></i> ${e}\n    <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>\n  `,document.body.appendChild(t),setTimeout((()=>{t.parentElement&&t.remove()}),5e3)}document.addEventListener("DOMContentLoaded",(function(){setupEventListeners(),autoFetch&&fetchLogs()})),window.goToPage=goToPage,window.fetchLogs=fetchLogs;