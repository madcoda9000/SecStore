document.addEventListener("DOMContentLoaded",(function(){const t=document.querySelector(".container[data-messages-save-success]"),e={saveSuccess:t?.dataset.messagesSaveSuccess||"Einstellungen gespeichert",saveError:t?.dataset.messagesSaveError||"Fehler beim Speichern",resetConfirm:t?.dataset.messagesResetConfirm||"Wirklich zurÃ¼cksetzen?",testStarted:t?.dataset.messagesTestStarted||"Test gestartet",loadError:t?.dataset.messagesLoadError||"Fehler beim Laden"},n=document.getElementById("rateLimitForm"),s=document.getElementById("enableRateLimit"),a=document.getElementById("resetToDefaults"),i=document.getElementById("testLimits"),o=document.getElementById("liveStatus"),l=new bootstrap.Toast(document.getElementById("successToast")),r=new bootstrap.Toast(document.getElementById("errorToast"));let c=null;const d={login:{requests:5,window:300},register:{requests:3,window:3600},"2fa":{requests:10,window:300},"forgot-password":{requests:3,window:3600},"reset-password":{requests:5,window:3600},admin:{requests:50,window:3600},global:{requests:500,window:3600}};function u(t){const e=document.getElementById("successMessage");e&&(e.textContent=t,l.show())}function m(t){const e=document.getElementById("errorMessage");e&&(e.textContent=t,r.show())}function v(){const t=s?.checked,e=n?.querySelectorAll("input:not(#enableRateLimit), select, button");e?.forEach((e=>{"enableRateLimit"!==e.id&&(e.disabled=!t)}));const a=n?.querySelector(".card-body");a&&(a.style.opacity=t?"1":"0.5"),h(new Event("submit"))}async function h(t){t.preventDefault();const s=document.getElementById("csrfToken");if(!s||!s.value)return void m("CSRF Token nicht gefunden!");const a=s.value,i=new FormData(n),l={};for(let[t,e]of i.entries())if(t.includes("[")&&t.includes("]")){const n=t.match(/(\w+)\[(\w+)\](?:\[(\w+)\])?/);if(n){const[,s,a,i]=n;l[s]||(l[s]={}),i?(l[s][a]||(l[s][a]={}),l[s][a][i]=isNaN(e)?e:parseInt(e)):l[s][a]=t.includes("log_violations")?"on"===e:isNaN(e)?e:parseInt(e)}}else l[t]="enabled"===t||e;const r={"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest","X-CSRF-Token":a};try{const t=await fetch("/admin/rate-limits/update",{method:"POST",headers:r,body:JSON.stringify(l)}),n=await t.json();if(!n.success)throw new Error(n.message||e.saveError);u(e.saveSuccess),o?.classList.contains("show")&&b()}catch(t){m(e.saveError)}}function w(){if(confirm(e.resetConfirm)){Object.entries(d).forEach((([t,e])=>{const s=n?.querySelector(`input[name="limits[${t}][requests]"]`),a=n?.querySelector(`input[name="limits[${t}][window]"]`);s&&(s.value=e.requests),a&&(a.value=e.window)}));const t=document.getElementById("maxViolations"),e=document.getElementById("cleanupInterval"),s=document.getElementById("logViolations");t&&(t.value=10),e&&(e.value=3600),s&&(s.checked=!0),u("Settings reset to defaults")}}async function g(){u(e.testStarted);const t=["/login","/register","/admin/settings","/reset-password/dwtfrkjswlgth","/forgot-password","/home","/2fa-verify"],n=[];for(const e of t)try{const t=await fetch(e,{method:"HEAD",headers:{"X-Test-Request":"true"}});n.push(`${e}: ${t.status}`)}catch(t){n.push(`${e}: Error`)}o?.classList.contains("show")&&b()}function p(){b(),c=setInterval(b,5e3)}function f(){c&&(clearInterval(c),c=null)}async function b(){const t=document.getElementById("liveStatusContent");if(t)try{const t=await fetch("/admin/rate-limits/status"),e=await t.json();if(!e)throw new Error("No data received");!function(t){const e=document.getElementById("liveStatusContent");if(!e)return;let n=`\n      <div class="row mb-3">\n        <div class="col-md-12">\n          <h6>Current Status: \n            <span class="badge bg-${t.enabled?"success":"warning"}">\n              ${t.enabled?"Enabled":"Disabled"}\n            </span>\n          </h6>\n        </div>\n      </div>\n      \n      <div class="row">\n        <div class="col-md-6">\n          <h6><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-activity " viewBox="0 0 16 16">\n  <path fill-rule="evenodd" d="M6 2a.5.5 0 0 1 .47.33L10 12.036l1.53-4.208A.5.5 0 0 1 12 7.5h3.5a.5.5 0 0 1 0 1h-3.15l-1.88 5.17a.5.5 0 0 1-.94 0L6 3.964 4.47 8.171A.5.5 0 0 1 4 8.5H.5a.5.5 0 0 1 0-1h3.15l1.88-5.17A.5.5 0 0 1 6 2"/>\n</svg> Active Limits</h6>\n          <div class="table-responsive">\n            <table class="table table-sm">\n              <thead>\n                <tr>\n                  <th>Type</th>\n                  <th>Current</th>\n                  <th>Max</th>\n                  <th>Status</th>\n                </tr>\n              </thead>\n              <tbody>\n    `;t.active_limits&&t.active_limits.length>0?t.active_limits.forEach((t=>{const e=t.max_requests>0?t.requests/t.max_requests*100:0,s=e>80?"danger":e>60?"warning":"success";n+=`\n          <tr>\n            <td><small>${t.type}</small></td>\n            <td>${t.requests||0}</td>\n            <td>${t.max_requests||"-"}</td>\n            <td>\n              <span class="badge bg-${s}">\n                ${Math.round(e)}%\n              </span>\n            </td>\n          </tr>\n        `})):n+='\n        <tr>\n          <td colspan="4" class="text-center text-muted">\n            <small>No active limits found</small>\n          </td>\n        </tr>\n      ';n+='\n              </tbody>\n            </table>\n          </div>\n        </div>\n        <div class="col-md-6">\n          <h6><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-exclamation-triangle" viewBox="0 0 16 16">\n  <path d="M7.938 2.016A.13.13 0 0 1 8.002 2a.13.13 0 0 1 .063.016.15.15 0 0 1 .054.057l6.857 11.667c.036.06.035.124.002.183a.2.2 0 0 1-.054.06.1.1 0 0 1-.066.017H1.146a.1.1 0 0 1-.066-.017.2.2 0 0 1-.054-.06.18.18 0 0 1 .002-.183L7.884 2.073a.15.15 0 0 1 .054-.057m1.044-.45a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767z"/>\n  <path d="M7.002 12a1 1 0 1 1 2 0 1 1 0 0 1-2 0M7.1 5.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0z"/>\n</svg> Recent Violations</h6>\n          <div class="list-group list-group-flush">\n    ',t.recent_violations&&t.recent_violations.length>0?t.recent_violations.slice(0,5).forEach((t=>{n+=`\n          <div class="list-group-item list-group-item-action py-2">\n            <div class="d-flex justify-content-between align-items-center">\n              <div>\n                <small class="text-muted">${t.timestamp||"Unknown time"}</small>\n                <br>\n                <span class="badge bg-secondary">${t.type||"Unknown"}</span>\n              </div>\n              <small class="text-muted">${t.identifier?t.identifier.substring(0,8)+"...":"Unknown"}</small>\n            </div>\n          </div>\n        `})):n+='\n        <div class="list-group-item text-center text-muted">\n          <span><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">\n  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>\n  <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/>\n</svg></span>\n          <p class="mb-0">No recent violations</p>\n        </div>\n      ';n+=`\n          </div>\n        </div>\n      </div>\n      \n      <div class="row mt-3">\n        <div class="col-md-12">\n          <div class="d-flex justify-content-between align-items-center">\n            <small class="text-muted">\n              Last updated: ${(new Date).toLocaleTimeString()}\n            </small>\n            <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadLiveStatus()">\n              <span><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">\n  <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>\n  <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>\n</svg></span> Refresh\n            </button>\n          </div>\n        </div>\n      </div>\n    `,e.innerHTML=n}(e)}catch(n){t.innerHTML=`\n        <div class="alert alert-warning">\n          <span class="bi bi-exclamation-triangle"></span>\n          ${e.loadError}\n        </div>\n      `}}v(),s?.addEventListener("change",v),n?.addEventListener("submit",h),a?.addEventListener("click",w),i?.addEventListener("click",g),o&&(o.addEventListener("shown.bs.collapse",p),o.addEventListener("hidden.bs.collapse",f),o.classList.contains("show")&&b()),window.loadLiveStatus=b}));