document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("users-messages"),t=e?.dataset.confirmDelete||"Are you sure you want to delete this user?",a=e?.dataset.deleteSuccess||"User deleted successfully",n=(e?.dataset.toggleSuccess,e?.dataset.toggleError||"Error updating status"),s=e?.dataset.accountActivated||"User account activated",i=e?.dataset.accountDeactivated||"User account deactivated",o=e?.dataset["2faEnabled"]||"2FA enabled successfully",c=e?.dataset["2faDisabled"]||"2FA disabled successfully",l=e?.dataset["2faEnforced"]||"2FA enforcement enabled",r=e?.dataset["2faUnenforced"]||"2FA enforcement disabled",d=document.getElementById("loadingIndicator"),u=document.getElementById("userTableBody"),b=new bootstrap.Modal(document.getElementById("confirmDeleteModal")),m=document.getElementById("deleteUserId"),f=document.getElementById("confirmDeleteBtn");function g(e){d&&(d.style.display=e?"block":"none")}function p(){[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).map((function(e){return new bootstrap.Tooltip(e)}))}function h(e=""){g(!0),u.innerHTML="",fetch(`/admin/users?search=${encodeURIComponent(e)}`,{headers:{"X-Requested-With":"XMLHttpRequest"}}).then((e=>e.json())).then((e=>{e.users&&e.users.length>0?function(e){let t="";e.forEach((e=>{t+=`\n                <tr>\n                    <td>\n                        ${1===e.ldapEnabled?'<i class="bi-hdd-network-fill text-teal" data-bs-toggle="tooltip" title="LDAP User"></i>':'<i class="bi-database-fill text-indigo" data-bs-toggle="tooltip" title="Database User"></i>'}\n                    </td>\n                    <td style="min-width:40px !important;text-align:center;">\n                        ${"super.admin"===e.username?'<i class="bi-check-circle-fill text-secondary" data-bs-toggle="tooltip" title="Cannot disable super admin"></i>':1===e.status?`<i id="accountStatus${e.id}" class="bi-check-circle-fill text-success user-action-btn" \n                                   data-action="toggle-account-status" data-user-id="${e.id}" data-operation="disable"\n                                   style="cursor:pointer;" data-bs-toggle="tooltip" title="Disable User"></i>`:`<i id="accountStatus${e.id}" class="bi-x-circle-fill text-danger user-action-btn" \n                                   data-action="toggle-account-status" data-user-id="${e.id}" data-operation="enable"\n                                   style="cursor:pointer;" data-bs-toggle="tooltip" title="Enable User"></i>`}\n                    </td>\n                    <td style="min-width:40px !important;text-align:center;">\n                        ${""!==e.mfaSecret&&1===e.mfaEnabled?`<i id="mfaEnabled${e.id}" class="bi-check-circle-fill text-success user-action-btn" \n                               data-action="toggle-mfa" data-user-id="${e.id}" data-operation="disable"\n                               data-bs-toggle="tooltip" title="Disable 2FA" style="cursor:pointer;"></i>`:""!==e.mfaSecret&&0===e.mfaEnabled?`<i id="mfaEnabled${e.id}" class="bi-x-circle-fill text-danger user-action-btn" \n                                   data-action="toggle-mfa" data-user-id="${e.id}" data-operation="enable"\n                                   data-bs-toggle="tooltip" title="Enable 2FA" style="cursor:pointer;"></i>`:`<i id="mfaEnabled${e.id}" class="bi-x-circle-fill text-secondary" data-bs-toggle="tooltip" title="User has not setup 2FA"></i>`}\n                    </td>\n                    <td style="min-width:40px !important;text-align:center;">\n                        ${"super.admin"===e.username?'<i class="bi-check-circle-fill text-secondary" data-bs-toggle="tooltip" title="2FA enforcement cannot be changed for super.admin"></i>':""!==e.mfaSecret?'<i class="bi-check-circle-fill text-secondary" data-bs-toggle="tooltip" title="2FA is configured already"></i>':1===e.mfaEnforced?`<i id="enforceStatus${e.id}" class="bi-check-circle-fill text-warning user-action-btn" \n                                       data-action="toggle-mfa-enforcement" data-user-id="${e.id}" data-operation="disable"\n                                       style="cursor:pointer;" data-bs-toggle="tooltip" title="Click to unenforce 2FA for user"></i>`:`<i id="enforceStatus${e.id}" class="bi-x-circle-fill text-danger user-action-btn" \n                                       data-action="toggle-mfa-enforcement" data-user-id="${e.id}" data-operation="enable"\n                                       style="cursor:pointer;" data-bs-toggle="tooltip" title="Click to enforce 2FA for user"></i>`}\n                    </td>\n                    <td>\n                        <strong>${e.username}</strong><br>\n                        <span class="text-muted">${e.firstname} ${e.lastname}</span><br>\n                        <span class="badge bg-info">${e.roles}</span>\n                    </td>\n                    <td>${e.email}</td>\n                    <td class="actions-column">\n                        ${"super.admin"===e.username?'<button class="btn btn-sm btn-secondary" disabled><i class="bi-trash-fill"></i> Delete</button>':`<button class="btn btn-sm btn-danger user-action-btn" \n                                     data-action="delete-user" data-user-id="${e.id}" data-username="${e.username}">\n                                <i class="bi-trash-fill"></i> Delete\n                             </button>`}\n                        <a href="/admin/showEditUser/${e.id}" class="btn btn-sm btn-warning">\n                            <i class="bi-pencil-fill"></i> Edit\n                        </a>\n                    </td>\n                </tr>\n            `})),u.innerHTML=t}(e.users):u.innerHTML='\n            <tr>\n                <td colspan="7" class="text-center py-4">\n                    <i class="bi bi-person-x text-muted" style="font-size: 3rem;"></i>\n                    <h5 class="text-muted mt-2">No users found</h5>\n                    <p class="text-muted">Try adjusting your search criteria</p>\n                </td>\n            </tr>\n        ',p()})).catch((e=>{showToast("Error loading users","danger","Error")})).finally((()=>{g(!1)}))}document.addEventListener("click",(function(e){const d=e.target.closest("[data-action]");if(!d)return;const u=d.dataset.action,p=d.dataset.userId,h=d.dataset.operation,E=d.dataset.username;switch(u){case"toggle-account-status":!function(e,t){if(!e||!t)return;const a="enable"===t?"/admin/enableUser":"/admin/disableUser",o=new FormData;o.append("id",e),o.append("csrf_token",document.getElementById("csrf_token").value),g(!0),fetch(a,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:o}).then((e=>e.json())).then((a=>{if(a.success){!function(e,t){const a=document.getElementById(`accountStatus${e}`),n=document.getElementById(`maccountStatus${e}`);[a,n].forEach((e=>{if(!e)return;"enable"===t?(e.className="bi-check-circle-fill text-success user-action-btn",e.dataset.operation="disable",e.title=e.dataset.bsOriginalTitle="Disable Useraccount"):(e.className="bi-x-circle-fill text-danger user-action-btn",e.dataset.operation="enable",e.title=e.dataset.bsOriginalTitle="Enable Useraccount");const a=bootstrap.Tooltip.getInstance(e);a&&(a.dispose(),new bootstrap.Tooltip(e))}))}(e,t);showToast("enable"===t?s:i,"success","Success")}else showToast(a.message||n,"danger","Error")})).catch((e=>{showToast(n,"danger","Error")})).finally((()=>{g(!1)}))}(p,h);break;case"toggle-mfa":!function(e,t){if(!e||!t)return;const a="enable"===t?"/admin/enableMfa":"/admin/disableMfa",s=new FormData;s.append("id",e),s.append("csrf_token",document.getElementById("csrf_token").value),g(!0),fetch(a,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:s}).then((e=>e.json())).then((a=>{if(a.success){!function(e,t){const a=document.getElementById(`mfaEnabled${e}`),n=document.getElementById(`mmfaEnabled${e}`);[a,n].forEach((e=>{if(!e)return;"enable"===t?(e.className="bi-check-circle-fill text-success user-action-btn",e.dataset.operation="disable",e.title=e.dataset.bsOriginalTitle="Disable 2FA"):(e.className="bi-x-circle-fill text-danger user-action-btn",e.dataset.operation="enable",e.title=e.dataset.bsOriginalTitle="Enable 2FA");const a=bootstrap.Tooltip.getInstance(e);a&&(a.dispose(),new bootstrap.Tooltip(e))}))}(e,t);showToast("enable"===t?o:c,"success","Success")}else showToast(a.message||n,"danger","Error")})).catch((e=>{showToast(n,"danger","Error")})).finally((()=>{g(!1)}))}(p,h);break;case"toggle-mfa-enforcement":!function(e,t){if(!e||!t)return;const a="enable"===t?"/admin/enforceMfa":"/admin/unenforceMfa",s=new FormData;s.append("id",e),s.append("csrf_token",document.getElementById("csrf_token").value),g(!0),fetch(a,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:s}).then((e=>e.json())).then((a=>{if(a.success){!function(e,t){const a=document.getElementById(`enforceStatus${e}`),n=document.getElementById(`menforceStatus${e}`);[a,n].forEach((e=>{if(!e)return;"enable"===t?(e.className="bi-check-circle-fill text-warning user-action-btn",e.dataset.operation="disable",e.title=e.dataset.bsOriginalTitle="Click to unenforce 2FA for user"):(e.className="bi-x-circle-fill text-danger user-action-btn",e.dataset.operation="enable",e.title=e.dataset.bsOriginalTitle="Click to enforce 2FA for user");const a=bootstrap.Tooltip.getInstance(e);a&&(a.dispose(),new bootstrap.Tooltip(e))}))}(e,t);showToast("enable"===t?l:r,"success","Success")}else showToast(a.message||n,"danger","Error")})).catch((e=>{showToast(n,"danger","Error")})).finally((()=>{g(!1)}))}(p,h);break;case"delete-user":!function(e,a){if(!e)return;m.value=e;document.querySelector("#confirmDeleteModal .modal-body p").textContent=`${t} "${a}"?`,b.show()}(p,E);break;case"confirm-delete":!function(){const e=m.value;if(!e)return;const t=new FormData;t.append("id",e),t.append("csrf_token",document.getElementById("csrf_token").value),f.disabled=!0,f.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Deleting...',fetch("/admin/deleteUser",{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:t}).then((e=>e.json())).then((e=>{e.success?(showToast(a,"success","Success"),b.hide(),setTimeout((()=>{window.location.reload()}),1e3)):showToast(e.message||"Error deleting user","danger","Error")})).catch((e=>{showToast("Error deleting user","danger","Error")})).finally((()=>{f.disabled=!1,f.innerHTML='<i class="bi-trash-fill"></i> Delete'}))}();break;case"create-user":window.location.href="/admin/showCreateUser";break}})),document.addEventListener("change",(function(e){"change-page-size"===e.target.dataset.action&&e.target.closest("form").submit()})),p(),b._element.addEventListener("hidden.bs.modal",(function(){m.value="",f.disabled=!1,f.innerHTML='<i class="bi-trash-fill"></i> Delete'}));const E=document.getElementById("searchInput");if(E){let e;E.addEventListener("input",(function(){clearTimeout(e),e=setTimeout((()=>{(this.value.length>=2||0===this.value.length)&&h(this.value)}),500)}))}}));