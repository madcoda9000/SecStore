document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("users-messages"),t=e?.dataset.confirmDelete||"Are you sure you want to delete this user?",a=e?.dataset.deleteSuccess||"User deleted successfully",n=(e?.dataset.toggleSuccess,e?.dataset.toggleError||"Error updating status"),s=e?.dataset.accountActivated||"User account activated",i=e?.dataset.accountDeactivated||"User account deactivated",o=e?.dataset["2faEnabled"]||"2FA enabled successfully",l=e?.dataset["2faDisabled"]||"2FA disabled successfully",c=e?.dataset["2faEnforced"]||"2FA enforcement enabled",r=e?.dataset["2faUnenforced"]||"2FA enforcement disabled",d=document.getElementById("loadingIndicator"),u=document.getElementById("userTableBody"),b=new bootstrap.Modal(document.getElementById("confirmDeleteModal")),g=document.getElementById("deleteUserId"),f=document.getElementById("confirmDeleteBtn");function m(e){d&&(e?d.classList.remove("d-none"):d.classList.add("d-none"))}function h(){[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).map((function(e){return new bootstrap.Tooltip(e)}))}function p(e=""){m(!0),u.innerHTML="",fetch(`/admin/users?search=${encodeURIComponent(e)}`,{headers:{"X-Requested-With":"XMLHttpRequest"}}).then((e=>e.json())).then((e=>{e.users&&e.users.length>0?function(e){let t="";e.forEach((e=>{let a="";a=1===e.entraIdEnabled?'<i class="bi-microsoft text-primary" data-bs-toggle="tooltip" title="Entra ID User"></i>':1===e.ldapEnabled?'<i class="bi-hdd-network-fill text-teal" data-bs-toggle="tooltip" title="LDAP User"></i>':'<i class="bi-database-fill text-indigo" data-bs-toggle="tooltip" title="Database User"></i>';let n="";n="super.admin"===e.username?'<i class="bi-check-circle-fill text-secondary" data-bs-toggle="tooltip" title="Cannot disable super admin"></i>':1===e.status?`<i id="accountStatus${e.id}" class="bi-check-circle-fill text-success user-action-btn" \n                             data-action="toggle-account-status" \n                             data-user-id="${e.id}" \n                             data-operation="disable"\n                             style="cursor:pointer;" \n                             data-bs-toggle="tooltip" \n                             title="Disable User"></i>`:`<i id="accountStatus${e.id}" class="bi-x-circle-fill text-danger user-action-btn" \n                             data-action="toggle-account-status" \n                             data-user-id="${e.id}" \n                             data-operation="enable"\n                             style="cursor:pointer;" \n                             data-bs-toggle="tooltip" \n                             title="Enable User"></i>`;let s="";s=1===e.entraIdEnabled?'<i class="bi-shield-lock-fill text-secondary" data-bs-toggle="tooltip" title="2FA is managed by Entra ID"></i>':""!==e.mfaSecret&&1===e.mfaEnabled?`<i id="mfaEnabled${e.id}" class="bi-check-circle-fill text-success user-action-btn" \n                          data-action="toggle-mfa" \n                          data-user-id="${e.id}" \n                          data-operation="disable"\n                          style="cursor:pointer;" \n                          data-bs-toggle="tooltip" \n                          title="Disable 2FA"></i>`:""!==e.mfaSecret&&0===e.mfaEnabled?`<i id="mfaEnabled${e.id}" class="bi-x-circle-fill text-danger user-action-btn" \n                          data-action="toggle-mfa" \n                          data-user-id="${e.id}" \n                          data-operation="enable"\n                          style="cursor:pointer;" \n                          data-bs-toggle="tooltip" \n                          title="Enable 2FA"></i>`:'<i class="bi-x-circle-fill text-secondary" data-bs-toggle="tooltip" title="No 2FA configured"></i>';let i="";i=1===e.entraIdEnabled?'<i class="bi-dash-circle text-secondary" data-bs-toggle="tooltip" title="Backup codes not available for Entra ID users"></i>':1===e.mfaEnabled?`<span class="backup-codes-cell text-secondary" \n                                data-user-id="${e.id}" role="status">\n                            <span class="visually-hidden">Loading...</span>\n                          </span>`:'<i class="bi-dash-circle text-secondary" data-bs-toggle="tooltip" title="No 2FA configured"></i>';let o="";o=1===e.entraIdEnabled?'<i class="bi-shield-lock-fill text-secondary" data-bs-toggle="tooltip" title="2FA enforcement is managed by Entra ID"></i>':"super.admin"===e.username?'<i class="bi-check-circle-fill text-secondary" data-bs-toggle="tooltip" title="Cannot enforce 2FA for super admin"></i>':""!==e.mfaSecret?'<i class="bi-check-circle-fill text-secondary" data-bs-toggle="tooltip" title="2FA already configured"></i>':1===e.mfaEnforced?`<i id="enforceStatus${e.id}" class="bi-check-circle-fill text-warning user-action-btn" \n                              data-action="toggle-mfa-enforcement" \n                              data-user-id="${e.id}" \n                              data-operation="disable"\n                              style="cursor:pointer;" \n                              data-bs-toggle="tooltip" \n                              title="Click to unenforce 2FA"></i>`:`<i id="enforceStatus${e.id}" class="bi-x-circle-fill text-danger user-action-btn" \n                              data-action="toggle-mfa-enforcement" \n                              data-user-id="${e.id}" \n                              data-operation="enable"\n                              style="cursor:pointer;" \n                              data-bs-toggle="tooltip" \n                              title="Click to enforce 2FA"></i>`,t+=`\n            <tr data-user-id="${e.id}" data-username="${e.username}">\n                <td>\n                    <div class="form-check">\n                        <input class="form-check-input user-select-checkbox" \n                            type="checkbox" \n                            value="${e.id}"\n                            data-username="${e.username}"\n                            data-action="update-selection">\n                    </div>\n                </td>\n                <td>${a}</td>\n                <td style="text-align:center;">${n}</td>\n                <td style="text-align:center;">${s}</td>\n                <td style="text-align:center;">${i}</td>\n                <td style="text-align:center;">${o}</td>\n                <td>\n                    <strong>${e.username}</strong><br>\n                    <span class="badge bg-info">${e.roles}</span>\n                </td>\n                <td>${e.email}</td>\n                <td class="actions-column">\n                    ${"super.admin"!==e.username?`<button class="btn btn-sm btn-danger user-action-btn" \n                                 data-action="delete-user" \n                                 data-user-id="${e.id}" \n                                 data-username="${e.username}">\n                            <i class="bi-trash-fill"></i> Delete\n                         </button>`:'<button class="btn btn-sm btn-secondary" disabled>\n                            <i class="bi-trash-fill"></i> Delete\n                         </button>'}\n                    <a href="/admin/showEditUser/${e.id}" class="btn btn-sm btn-warning">\n                        <i class="bi-pencil-fill"></i> Edit\n                    </a>\n                </td>\n            </tr>\n        `})),u.innerHTML=t,"function"==typeof window.loadAllBackupCodes&&window.loadAllBackupCodes()}(e.users):u.innerHTML='\n            <tr>\n                <td colspan="9" class="text-center py-4">\n                    <i class="bi bi-person-x text-muted" style="font-size: 3rem;"></i>\n                    <h5 class="text-muted mt-2">No users found</h5>\n                    <p class="text-muted">Try adjusting your search criteria</p>\n                </td>\n            </tr>\n        ',h()})).catch((e=>{showToast("Error loading users","danger","Error")})).finally((()=>{m(!1)}))}document.addEventListener("click",(function(e){const d=e.target.closest("[data-action]");if(!d)return;const u=d.dataset.action,h=d.dataset.userId,p=d.dataset.operation,w=d.dataset.username;switch(u){case"toggle-account-status":!function(e,t){if(!e||!t)return;const a="enable"===t?"/admin/enableUser":"/admin/disableUser";m(!1),fetch(a,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-Requested-With":"XMLHttpRequest"},body:new URLSearchParams({id:e,csrf_token:document.getElementById("csrf_token").value})}).then((e=>e.json())).then((a=>{if(a.success){!function(e,t){const a='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-x-circle-fill text-danger" viewBox="0 0 16 16">\n      <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/>\n    </svg>',n='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-check-circle-fill text-success" viewBox="0 0 16 16">\n      <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.022-1.06z"/>\n    </svg>',s=document.getElementById(`accountStatus${e}`),i=document.getElementById(`maccountStatus${e}`);[s,i].forEach((e=>{if(!e)return;const s=bootstrap.Tooltip.getInstance(e);s&&(s.hide(),setTimeout((()=>s.dispose()),200)),"enable"===t?(e.dataset.operation="disable",e.title="Disable Useraccount",e.innerHTML=n):(e.dataset.operation="enable",e.title="Enable Useraccount",e.innerHTML=a),setTimeout((()=>{new bootstrap.Tooltip(e)}),250)}))}(e,t);showToast("enable"===t?s:i,"success","Success")}else showToast(a.message||n,"danger","Error")})).catch((e=>{showToast(n,"danger","Error")})).finally((()=>{m(!1)}))}(h,p);break;case"toggle-mfa":!function(e,t){if(!e||!t)return;const a="enable"===t?"/admin/enableMfa":"/admin/disableMfa";m(!1),fetch(a,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-Requested-With":"XMLHttpRequest"},body:new URLSearchParams({id:e,csrf_token:document.getElementById("csrf_token").value})}).then((e=>e.json())).then((a=>{if(a.success){!function(e,t){const a='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-x-circle-fill text-secondary" viewBox="0 0 16 16">\n      <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/>\n    </svg>',n='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-check-circle-fill text-success" viewBox="0 0 16 16">\n      <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.022-1.06z"/>\n    </svg>',s=document.getElementById(`mfaEnabled${e}`),i=document.getElementById(`mmfaEnabled${e}`);[s,i].forEach((e=>{if(!e)return;const s=bootstrap.Tooltip.getInstance(e);s&&(s.hide(),setTimeout((()=>s.dispose()),200)),"enable"===t?(e.dataset.operation="disable",e.title="Disable 2FA",e.innerHTML=n):(e.dataset.operation="enable",e.title="Enable 2FA",e.innerHTML=a),setTimeout((()=>{new bootstrap.Tooltip(e)}),250)}))}(e,t);showToast("enable"===t?o:l,"success","Success")}else showToast(a.message||n,"danger","Error")})).catch((e=>{showToast(n,"danger","Error")})).finally((()=>{m(!1)}))}(h,p);break;case"toggle-mfa-enforcement":!function(e,t){if(!e||!t)return;const a="enable"===t?"/admin/enforceMfa":"/admin/unenforceMfa";m(!1),fetch(a,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-Requested-With":"XMLHttpRequest"},body:new URLSearchParams({id:e,csrf_token:document.getElementById("csrf_token").value})}).then((e=>e.json())).then((a=>{if(a.success){!function(e,t){const a='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-x-circle-fill text-secondary" viewBox="0 0 16 16">\n      <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/>\n    </svg>',n='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-check-circle-fill text-warning" viewBox="0 0 16 16">\n      <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.022-1.06z"/>\n    </svg>',s=document.getElementById(`enforceStatus${e}`),i=document.getElementById(`menforceStatus${e}`);[s,i].forEach((e=>{if(!e)return;const s=bootstrap.Tooltip.getInstance(e);s&&(s.hide(),setTimeout((()=>s.dispose()),200)),"enable"===t?(e.dataset.operation="disable",e.title="Click to unenforce 2FA for user",e.innerHTML=n):(e.dataset.operation="enable",e.title="Click to enforce 2FA for user",e.innerHTML=a),setTimeout((()=>{new bootstrap.Tooltip(e)}),250)}))}(e,t);showToast("enable"===t?c:r,"success","Success")}else showToast(a.message||n,"danger","Error")})).catch((e=>{showToast(n,"danger","Error")})).finally((()=>{m(!1)}))}(h,p);break;case"delete-user":!function(e,a){if(!e)return;g.value=e;document.querySelector("#confirmDeleteModal .modal-body p").textContent=`${t} "${a}"?`,b.show()}(h,w);break;case"confirm-delete":!function(){const e=g.value;if(!e)return;f.disabled=!0,f.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Deleting...',fetch("/admin/deleteUser",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-Requested-With":"XMLHttpRequest"},body:new URLSearchParams({id:e,csrf_token:document.getElementById("csrf_token").value})}).then((e=>e.json())).then((e=>{e.success?(showToast(a,"success","Success"),b.hide(),setTimeout((()=>{window.location.reload()}),1e3)):showToast(e.message||"Error deleting user","danger","Error")})).catch((e=>{showToast("Error deleting user","danger","Error")})).finally((()=>{f.disabled=!1,f.innerHTML='<i class="bi-trash-fill"></i> Delete'}))}();break;case"create-user":window.location.href="/admin/showCreateUser";break}})),document.addEventListener("change",(function(e){"change-page-size"===e.target.dataset.action&&e.target.closest("form").submit()})),h(),b._element.addEventListener("hidden.bs.modal",(function(){g.value="",f.disabled=!1,f.innerHTML='<i class="bi-trash-fill"></i> Delete'}));const w=document.getElementById("searchInput");if(w){let e;w.addEventListener("input",(function(){clearTimeout(e),e=setTimeout((()=>{(this.value.length>=2||0===this.value.length)&&p(this.value)}),500)}))}}));