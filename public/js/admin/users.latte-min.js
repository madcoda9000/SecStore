document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("users-messages"),t=e?.dataset.confirmDelete||"Are you sure you want to delete this user?",a=e?.dataset.deleteSuccess||"User deleted successfully",n=(e?.dataset.toggleSuccess,e?.dataset.toggleError||"Error updating status"),s=e?.dataset.accountActivated||"User account activated",o=e?.dataset.accountDeactivated||"User account deactivated",i=e?.dataset["2faEnabled"]||"2FA enabled successfully",l=e?.dataset["2faDisabled"]||"2FA disabled successfully",c=e?.dataset["2faEnforced"]||"2FA enforcement enabled",d=e?.dataset["2faUnenforced"]||"2FA enforcement disabled",r=document.getElementById("loadingIndicator"),u=document.getElementById("userTableBody"),b=new bootstrap.Modal(document.getElementById("confirmDeleteModal")),f=document.getElementById("deleteUserId"),m=document.getElementById("confirmDeleteBtn");function g(e){r&&(r.style.display=e?"block":"none")}function p(){[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).map((function(e){return new bootstrap.Tooltip(e)}))}function h(e=""){g(!0),u.innerHTML="",fetch(`/admin/users?search=${encodeURIComponent(e)}`,{headers:{"X-Requested-With":"XMLHttpRequest"}}).then((e=>e.json())).then((e=>{e.users&&e.users.length>0?function(e){let t="";e.forEach((e=>{let a="";a=1===e.entraIdEnabled?'<i class="bi-microsoft text-primary" data-bs-toggle="tooltip" title="Entra ID User"></i>':1===e.ldapEnabled?'<i class="bi-hdd-network-fill text-teal" data-bs-toggle="tooltip" title="LDAP User"></i>':'<i class="bi-database-fill text-indigo" data-bs-toggle="tooltip" title="Database User"></i>';let n="";n="super.admin"===e.username?'<i class="bi-check-circle-fill text-secondary" data-bs-toggle="tooltip" title="Cannot disable super admin"></i>':1===e.status?`<i id="accountStatus${e.id}" class="bi-check-circle-fill text-success user-action-btn" \n                             data-action="toggle-account-status" \n                             data-user-id="${e.id}" \n                             data-operation="disable"\n                             style="cursor:pointer;" \n                             data-bs-toggle="tooltip" \n                             title="Disable User"></i>`:`<i id="accountStatus${e.id}" class="bi-x-circle-fill text-danger user-action-btn" \n                             data-action="toggle-account-status" \n                             data-user-id="${e.id}" \n                             data-operation="enable"\n                             style="cursor:pointer;" \n                             data-bs-toggle="tooltip" \n                             title="Enable User"></i>`;let s="";s=1===e.entraIdEnabled?'<i class="bi-shield-lock-fill text-secondary" data-bs-toggle="tooltip" title="2FA is managed by Entra ID"></i>':""!==e.mfaSecret&&1===e.mfaEnabled?`<i id="mfaEnabled${e.id}" class="bi-check-circle-fill text-success user-action-btn" \n                          data-action="toggle-mfa" \n                          data-user-id="${e.id}" \n                          data-operation="disable"\n                          style="cursor:pointer;" \n                          data-bs-toggle="tooltip" \n                          title="Disable 2FA"></i>`:""!==e.mfaSecret&&0===e.mfaEnabled?`<i id="mfaEnabled${e.id}" class="bi-x-circle-fill text-danger user-action-btn" \n                          data-action="toggle-mfa" \n                          data-user-id="${e.id}" \n                          data-operation="enable"\n                          style="cursor:pointer;" \n                          data-bs-toggle="tooltip" \n                          title="Enable 2FA"></i>`:'<i class="bi-x-circle-fill text-secondary" data-bs-toggle="tooltip" title="No 2FA configured"></i>';let o="";o=1===e.entraIdEnabled?'<i class="bi-dash-circle text-secondary" data-bs-toggle="tooltip" title="Backup codes not available for Entra ID users"></i>':1===e.mfaEnabled?`<span class="backup-codes-cell text-secondary" \n                                data-user-id="${e.id}" role="status">\n                            <span class="visually-hidden">Loading...</span>\n                          </span>`:'<i class="bi-dash-circle text-secondary" data-bs-toggle="tooltip" title="No 2FA configured"></i>';let i="";i=1===e.entraIdEnabled?'<i class="bi-shield-lock-fill text-secondary" data-bs-toggle="tooltip" title="2FA enforcement is managed by Entra ID"></i>':"super.admin"===e.username?'<i class="bi-check-circle-fill text-secondary" data-bs-toggle="tooltip" title="Cannot enforce 2FA for super admin"></i>':""!==e.mfaSecret?'<i class="bi-check-circle-fill text-secondary" data-bs-toggle="tooltip" title="2FA already configured"></i>':1===e.mfaEnforced?`<i id="enforceStatus${e.id}" class="bi-check-circle-fill text-warning user-action-btn" \n                              data-action="toggle-mfa-enforcement" \n                              data-user-id="${e.id}" \n                              data-operation="disable"\n                              style="cursor:pointer;" \n                              data-bs-toggle="tooltip" \n                              title="Click to unenforce 2FA"></i>`:`<i id="enforceStatus${e.id}" class="bi-x-circle-fill text-danger user-action-btn" \n                              data-action="toggle-mfa-enforcement" \n                              data-user-id="${e.id}" \n                              data-operation="enable"\n                              style="cursor:pointer;" \n                              data-bs-toggle="tooltip" \n                              title="Click to enforce 2FA"></i>`,t+=`\n            <tr data-user-id="${e.id}" data-username="${e.username}">\n                <td>\n                    <div class="form-check">\n                        <input class="form-check-input user-select-checkbox" \n                            type="checkbox" \n                            value="${e.id}"\n                            data-username="${e.username}"\n                            data-action="update-selection">\n                    </div>\n                </td>\n                <td>${a}</td>\n                <td style="text-align:center;">${n}</td>\n                <td style="text-align:center;">${s}</td>\n                <td style="text-align:center;">${o}</td>\n                <td style="text-align:center;">${i}</td>\n                <td>\n                    <strong>${e.username}</strong><br>\n                    <span class="badge bg-info">${e.roles}</span>\n                </td>\n                <td>${e.email}</td>\n                <td class="actions-column">\n                    ${"super.admin"!==e.username?`<button class="btn btn-sm btn-danger user-action-btn" \n                                 data-action="delete-user" \n                                 data-user-id="${e.id}" \n                                 data-username="${e.username}">\n                            <i class="bi-trash-fill"></i> Delete\n                         </button>`:'<button class="btn btn-sm btn-secondary" disabled>\n                            <i class="bi-trash-fill"></i> Delete\n                         </button>'}\n                    <a href="/admin/showEditUser/${e.id}" class="btn btn-sm btn-warning">\n                        <i class="bi-pencil-fill"></i> Edit\n                    </a>\n                </td>\n            </tr>\n        `})),u.innerHTML=t,"function"==typeof window.loadAllBackupCodes&&window.loadAllBackupCodes()}(e.users):u.innerHTML='\n            <tr>\n                <td colspan="9" class="text-center py-4">\n                    <i class="bi bi-person-x text-muted" style="font-size: 3rem;"></i>\n                    <h5 class="text-muted mt-2">No users found</h5>\n                    <p class="text-muted">Try adjusting your search criteria</p>\n                </td>\n            </tr>\n        ',p()})).catch((e=>{showToast("Error loading users","danger","Error")})).finally((()=>{g(!1)}))}document.addEventListener("click",(function(e){const r=e.target.closest("[data-action]");if(!r)return;const u=r.dataset.action,p=r.dataset.userId,h=r.dataset.operation,y=r.dataset.username;switch(u){case"toggle-account-status":!function(e,t){if(!e||!t)return;const a="enable"===t?"/admin/enableUser":"/admin/disableUser",i=new FormData;i.append("id",e),i.append("csrf_token",document.getElementById("csrf_token").value),g(!0),fetch(a,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:i}).then((e=>e.json())).then((a=>{if(a.success){!function(e,t){const a=document.getElementById(`accountStatus${e}`),n=document.getElementById(`maccountStatus${e}`);[a,n].forEach((e=>{if(!e)return;const a=bootstrap.Tooltip.getInstance(e);a&&(a.hide(),setTimeout((()=>a.dispose()),200)),"enable"===t?(e.className="bi-check-circle-fill text-success user-action-btn",e.dataset.operation="disable",e.title="Disable Useraccount"):(e.className="bi-x-circle-fill text-danger user-action-btn",e.dataset.operation="enable",e.title="Enable Useraccount"),setTimeout((()=>{new bootstrap.Tooltip(e)}),250)}))}(e,t);showToast("enable"===t?s:o,"success","Success")}else showToast(a.message||n,"danger","Error")})).catch((e=>{showToast(n,"danger","Error")})).finally((()=>{g(!1)}))}(p,h);break;case"toggle-mfa":!function(e,t){if(!e||!t)return;const a="enable"===t?"/admin/enableMfa":"/admin/disableMfa",s=new FormData;s.append("id",e),s.append("csrf_token",document.getElementById("csrf_token").value),g(!0),fetch(a,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:s}).then((e=>e.json())).then((a=>{if(a.success){!function(e,t){const a=document.getElementById(`mfaEnabled${e}`),n=document.getElementById(`mmfaEnabled${e}`);[a,n].forEach((e=>{if(!e)return;const a=bootstrap.Tooltip.getInstance(e);a&&(a.hide(),setTimeout((()=>a.dispose()),200)),"enable"===t?(e.className="bi-check-circle-fill text-success user-action-btn",e.dataset.operation="disable",e.title="Disable 2FA"):(e.className="bi-x-circle-fill text-danger user-action-btn",e.dataset.operation="enable",e.title="Enable 2FA"),setTimeout((()=>{new bootstrap.Tooltip(e)}),250)}))}(e,t);showToast("enable"===t?i:l,"success","Success")}else showToast(a.message||n,"danger","Error")})).catch((e=>{showToast(n,"danger","Error")})).finally((()=>{g(!1)}))}(p,h);break;case"toggle-mfa-enforcement":!function(e,t){if(!e||!t)return;const a="enable"===t?"/admin/enforceMfa":"/admin/unenforceMfa",s=new FormData;s.append("id",e),s.append("csrf_token",document.getElementById("csrf_token").value),g(!0),fetch(a,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:s}).then((e=>e.json())).then((a=>{if(a.success){!function(e,t){const a=document.getElementById(`enforceStatus${e}`),n=document.getElementById(`menforceStatus${e}`);[a,n].forEach((e=>{if(!e)return;const a=bootstrap.Tooltip.getInstance(e);a&&(a.hide(),setTimeout((()=>a.dispose()),200)),"enable"===t?(e.className="bi-check-circle-fill text-warning user-action-btn",e.dataset.operation="disable",e.title="Click to unenforce 2FA for user"):(e.className="bi-x-circle-fill text-secondary user-action-btn",e.dataset.operation="enable",e.title="Click to enforce 2FA for user"),setTimeout((()=>{new bootstrap.Tooltip(e)}),250)}))}(e,t);showToast("enable"===t?c:d,"success","Success")}else showToast(a.message||n,"danger","Error")})).catch((e=>{showToast(n,"danger","Error")})).finally((()=>{g(!1)}))}(p,h);break;case"delete-user":!function(e,a){if(!e)return;f.value=e;document.querySelector("#confirmDeleteModal .modal-body p").textContent=`${t} "${a}"?`,b.show()}(p,y);break;case"confirm-delete":!function(){const e=f.value;if(!e)return;const t=new FormData;t.append("id",e),t.append("csrf_token",document.getElementById("csrf_token").value),m.disabled=!0,m.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Deleting...',fetch("/admin/deleteUser",{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:t}).then((e=>e.json())).then((e=>{e.success?(showToast(a,"success","Success"),b.hide(),setTimeout((()=>{window.location.reload()}),1e3)):showToast(e.message||"Error deleting user","danger","Error")})).catch((e=>{showToast("Error deleting user","danger","Error")})).finally((()=>{m.disabled=!1,m.innerHTML='<i class="bi-trash-fill"></i> Delete'}))}();break;case"create-user":window.location.href="/admin/showCreateUser";break}})),document.addEventListener("change",(function(e){"change-page-size"===e.target.dataset.action&&e.target.closest("form").submit()})),p(),b._element.addEventListener("hidden.bs.modal",(function(){f.value="",m.disabled=!1,m.innerHTML='<i class="bi-trash-fill"></i> Delete'}));const y=document.getElementById("searchInput");if(y){let e;y.addEventListener("input",(function(){clearTimeout(e),e=setTimeout((()=>{(this.value.length>=2||0===this.value.length)&&h(this.value)}),500)}))}}));