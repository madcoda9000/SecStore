document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("typeFilter"),t=document.getElementById("timeFilter"),n=document.getElementById("searchFilter"),s=document.getElementById("applyFilters"),i=document.getElementById("refreshData"),a=document.getElementById("clearViolations"),o=document.getElementById("autoRefresh"),c=document.getElementById("liveUpdate"),l=document.getElementById("violationsTableBody"),d=new bootstrap.Modal(document.getElementById("detailsModal")),r=new bootstrap.Toast(document.getElementById("successToast")),u=new bootstrap.Toast(document.getElementById("errorToast"));let m=null,p=null,b={type:"",time:"24h",search:""};function f(){b={type:e.value,time:t.value,search:n.value.trim()},g()}function g(){const e=l.querySelectorAll("tr");let t=0;e.forEach((e=>{const n=e.dataset.identifier,s=e.dataset.type,i=e.querySelector("td:first-child small"),a=i?i.textContent:"";let o=!0;if(b.type&&s!==b.type&&(o=!1),b.search&&!n.toLowerCase().includes(b.search.toLowerCase())&&(o=!1),"all"!==b.time){const e=new Date-new Date(a);switch(b.time){case"1h":e>36e5&&(o=!1);break;case"24h":e>864e5&&(o=!1);break;case"7d":e>6048e5&&(o=!1);break}}e.style.display=o?"":"none",o&&t++}));const n=document.querySelector(".card-header small");n&&(n.textContent=`Showing ${t} violations`)}function h(){const e=i.innerHTML;i.innerHTML='<span class="spinner-border spinner-border-sm"></span> Loading...',i.disabled=!0,setTimeout((()=>{i.innerHTML=e,i.disabled=!1,k("Data refreshed successfully"),g()}),1e3)}function y(){if(confirm(messages.clearConfirm)){a.disabled=!0;const e=a.innerHTML;a.innerHTML='<span class="spinner-border spinner-border-sm"></span>';const t=document.getElementById("csrfToken")?.value||document.querySelector('meta[name="csrf-token"]')?.getAttribute("content");if(!t)throw new Error("CSRF Token nicht gefunden");fetch("/admin/rate-limits/clear",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest","X-CSRF-Token":t}}).then((e=>e.json())).then((e=>{if(!e.success)throw new Error(e.message);l.innerHTML=`\n                        <tr>\n                            <td colspan="4" class="text-center text-muted py-5">\n                                <span class="bi bi-shield-check display-1"></span>\n                                <h5 class="mt-3">${messages.noData}</h5>\n                                <p class="mb-0">All violations have been cleared</p>\n                            </td>\n                        </tr>\n                    `,k(messages.clearSuccess)})).catch((e=>{M(messages.clearError)})).finally((()=>{a.disabled=!1,a.innerHTML=e}))}}function v(){o.checked?L():E()}function w(){c.checked?T():I()}function L(){m=setInterval((()=>{h()}),3e4)}function E(){m&&(clearInterval(m),m=null)}function T(){p=setInterval((()=>{!function(){const e=document.querySelector("#liveUpdate + label");e&&c.checked&&(e.style.color="#28a745",setTimeout((()=>{e.style.color=""}),200))}()}),5e3)}function I(){p&&(clearInterval(p),p=null)}function k(e){document.getElementById("successMessage").textContent=e,r.show()}function M(e){document.getElementById("errorMessage").textContent=e,u.show()}s.addEventListener("click",f),i.addEventListener("click",h),a.addEventListener("click",y),o.addEventListener("change",v),c.addEventListener("change",w),n.addEventListener("keypress",(function(e){"Enter"===e.key&&f()})),document.addEventListener("click",(function(e){e.target.closest(".reset-limit-btn")&&async function(e){const t=e.dataset.identifier,n=e.dataset.type;if(!t)return;e.disabled=!0;const s=e.innerHTML;e.innerHTML='<span class="spinner-border spinner-border-sm"></span>';try{const i=await fetch("/admin/rate-limits/reset",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({identifier:t,limit_type:n})}),a=await i.json();if(!a.success)throw new Error(a.message);k(messages.resetSuccess),e.classList.remove("btn-outline-primary"),e.classList.add("btn-outline-success"),setTimeout((()=>{e.classList.remove("btn-outline-success"),e.classList.add("btn-outline-primary")}),2e3)}catch(e){M(messages.resetError)}finally{e.disabled=!1,e.innerHTML=s}}(e.target.closest(".reset-limit-btn")),e.target.closest(".view-details-btn")&&function(e){const t=e.dataset.identifier;if(!t)return;const n=document.getElementById("detailsModalBody");n.innerHTML='\n            <div class="text-center">\n                <div class="spinner-border" role="status">\n                    <span class="visually-hidden">Loading...</span>\n                </div>\n                <p class="mt-2">Loading violation details...</p>\n            </div>\n        ',d.show(),setTimeout((()=>{n.innerHTML=`\n                <div class="row">\n                    <div class="col-md-6">\n                        <h6>Identifier Information</h6>\n                        <dl class="row">\n                            <dt class="col-sm-4">Full Hash:</dt>\n                            <dd class="col-sm-8"><code>${t}</code></dd>\n                            <dt class="col-sm-4">Short ID:</dt>\n                            <dd class="col-sm-8"><code>${t.substring(0,12)}...</code></dd>\n                            <dt class="col-sm-4">First Seen:</dt>\n                            <dd class="col-sm-8">2 hours ago</dd>\n                            <dt class="col-sm-4">Total Violations:</dt>\n                            <dd class="col-sm-8"><span class="badge bg-danger">15</span></dd>\n                        </dl>\n                    </div>\n                    <div class="col-md-6">\n                        <h6>Recent Activity</h6>\n                        <div class="list-group list-group-flush">\n                            <div class="list-group-item d-flex justify-content-between">\n                                <span>Login attempts</span>\n                                <span class="badge bg-danger">8</span>\n                            </div>\n                            <div class="list-group-item d-flex justify-content-between">\n                                <span>2FA attempts</span>\n                                <span class="badge bg-warning">4</span>\n                            </div>\n                            <div class="list-group-item d-flex justify-content-between">\n                                <span>API calls</span>\n                                <span class="badge bg-info">3</span>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n                \n                <hr>\n                \n                <h6>Recommended Actions</h6>\n                <div class="alert alert-warning">\n                    <span class="bi bi-exclamation-triangle"></span>\n                    This identifier shows suspicious activity patterns. Consider:\n                    <ul class="mb-0 mt-2">\n                        <li>Temporarily blocking this identifier</li>\n                        <li>Reducing rate limits for this specific user</li>\n                        <li>Monitoring for continued violations</li>\n                    </ul>\n                </div>\n                \n                <div class="d-flex justify-content-end">\n                    <button type="button" class="btn btn-warning btn-sm me-2">\n                        <span class="bi bi-shield"></span> Block Identifier\n                    </button>\n                    <button type="button" class="btn btn-primary btn-sm">\n                        <span class="bi bi-arrow-clockwise"></span> Reset Limits\n                    </button>\n                </div>\n            `}),1e3)}(e.target.closest(".view-details-btn"))})),o.checked&&L(),c.checked&&T(),g(),window.addEventListener("beforeunload",(function(){E(),I()}))}));