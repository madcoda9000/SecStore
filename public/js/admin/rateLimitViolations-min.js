document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("typeFilter"),t=document.getElementById("timeFilter"),n=document.getElementById("searchFilter"),s=document.getElementById("applyFilters"),i=document.getElementById("refreshData"),a=document.getElementById("clearViolations"),o=document.getElementById("autoRefresh"),d=document.getElementById("liveUpdate"),c=document.getElementById("violationsTableBody"),l=new bootstrap.Modal(document.getElementById("detailsModal")),r=new bootstrap.Modal(document.getElementById("confirmClearModal")),u=document.getElementById("confirmClearBtn"),m=new bootstrap.Toast(document.getElementById("successToast")),p=new bootstrap.Toast(document.getElementById("errorToast"));let f=null,g=null,b={type:"",time:"24h",search:""};function y(){b={type:e.value,time:t.value,search:n.value.trim()},h()}function h(){const e=c.querySelectorAll("tr");let t=0;e.forEach((e=>{const n=e.dataset.identifier,s=e.dataset.type,i=e.querySelector("td:first-child small"),a=i?i.textContent:"";let o=!0;if(b.type&&s!==b.type&&(o=!1),b.search&&!n.toLowerCase().includes(b.search.toLowerCase())&&(o=!1),"all"!==b.time){const e=new Date-new Date(a);switch(b.time){case"1h":e>36e5&&(o=!1);break;case"24h":e>864e5&&(o=!1);break;case"7d":e>6048e5&&(o=!1);break}}e.style.display=o?"":"none",o&&t++}));const n=document.querySelector(".card-header small");n&&(n.textContent=`Showing ${t} violations`)}function v(){const e=i.innerHTML;i.innerHTML='<span class="spinner-border spinner-border-sm"></span> Loading...',i.disabled=!0,setTimeout((()=>{i.innerHTML=e,i.disabled=!1,x("Data refreshed successfully"),h()}),1e3)}function w(){r.show()}function E(){r.hide(),L(a,!0),L(u,!0);const e=document.getElementById("csrf_token")?.value||document.getElementById("csrfToken")?.value||document.querySelector('meta[name="csrf-token"]')?.getAttribute("content");if(!e)return H("CSRF Token nicht gefunden"),void T();fetch("/admin/rate-limits/clear",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest","X-CSRF-Token":e}}).then((e=>e.json())).then((e=>{if(!e.success)throw new Error(e.message);x(messages.clearSuccess),setTimeout((()=>{window.location.reload()}),1500)})).catch((e=>{H(messages.clearError),T()}))}function L(e,t){e&&(t?(e.disabled=!0,e.dataset.originalText||(e.dataset.originalText=e.innerHTML),e.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>LÃ¶sche...'):(e.disabled=!1,e.dataset.originalText&&(e.innerHTML=e.dataset.originalText)))}function T(){L(a,!1),L(u,!1)}function I(){o.checked?k():M()}function B(){d.checked?C():S()}function k(){f=setInterval((()=>{v()}),3e4)}function M(){f&&(clearInterval(f),f=null)}function C(){g=setInterval((()=>{!function(){const e=document.querySelector("#liveUpdate + label");e&&d.checked&&(e.style.color="#28a745",setTimeout((()=>{e.style.color=""}),200))}()}),5e3)}function S(){g&&(clearInterval(g),g=null)}function x(e){document.getElementById("successMessage").textContent=e,m.show()}function H(e){document.getElementById("errorMessage").textContent=e,p.show()}!function(){s.addEventListener("click",y),i.addEventListener("click",v),a.addEventListener("click",w),o.addEventListener("change",I),d.addEventListener("change",B),u&&u.addEventListener("click",E);document.getElementById("confirmClearModal").addEventListener("hidden.bs.modal",(function(){L(u,!1)})),n.addEventListener("keypress",(function(e){"Enter"===e.key&&y()})),document.addEventListener("click",(function(e){e.target.closest(".reset-limit-btn")&&async function(e){const t=e.dataset.identifier,n=e.dataset.type;if(!t)return;e.disabled=!0;const s=e.innerHTML;e.innerHTML='<span class="spinner-border spinner-border-sm"></span>';try{const i=await fetch("/admin/rate-limits/reset",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({identifier:t,limit_type:n})}),a=await i.json();if(!a.success)throw new Error(a.message);x(messages.resetSuccess),e.classList.remove("btn-outline-primary"),e.classList.add("btn-outline-success"),setTimeout((()=>{e.classList.remove("btn-outline-success"),e.classList.add("btn-outline-primary")}),2e3)}catch(e){H(messages.resetError)}finally{e.disabled=!1,e.innerHTML=s}}(e.target.closest(".reset-limit-btn")),e.target.closest(".view-details-btn")&&function(e){const t=e.dataset.identifier;if(!t)return;const n=document.getElementById("detailsModalBody");n.innerHTML='\n            <div class="text-center">\n                <div class="spinner-border" role="status">\n                    <span class="visually-hidden">Loading...</span>\n                </div>\n                <p class="mt-2">Loading violation details...</p>\n            </div>\n        ',l.show(),setTimeout((()=>{n.innerHTML=`\n                <div class="row">\n                    <div class="col-md-6">\n                        <h6>Identifier Information</h6>\n                        <dl class="row">\n                            <dt class="col-sm-4">Full Hash:</dt>\n                            <dd class="col-sm-8"><code>${t}</code></dd>\n                            <dt class="col-sm-4">Short ID:</dt>\n                            <dd class="col-sm-8"><code>${t.substring(0,12)}...</code></dd>\n                            <dt class="col-sm-4">First Seen:</dt>\n                            <dd class="col-sm-8">2 hours ago</dd>\n                            <dt class="col-sm-4">Total Violations:</dt>\n                            <dd class="col-sm-8"><span class="badge bg-danger">15</span></dd>\n                        </dl>\n                    </div>\n                    <div class="col-md-6">\n                        <h6>Recent Activity</h6>\n                        <div class="list-group list-group-flush">\n                            <div class="list-group-item d-flex justify-content-between">\n                                <span>Login attempts</span>\n                                <span class="badge bg-danger">8</span>\n                            </div>\n                            <div class="list-group-item d-flex justify-content-between">\n                                <span>2FA attempts</span>\n                                <span class="badge bg-warning">4</span>\n                            </div>\n                            <div class="list-group-item d-flex justify-content-between">\n                                <span>API calls</span>\n                                <span class="badge bg-info">3</span>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n                \n                <hr>\n                \n                <h6>Recommended Actions</h6>\n                <div class="alert alert-warning">\n                    <span class="bi bi-exclamation-triangle"></span>\n                    This identifier shows suspicious activity patterns. Consider:\n                    <ul class="mb-0 mt-2">\n                        <li>Temporarily blocking this identifier</li>\n                        <li>Reducing rate limits for this specific user</li>\n                        <li>Monitoring for continued violations</li>\n                    </ul>\n                </div>\n                \n                <div class="d-flex justify-content-end">\n                    <button type="button" class="btn btn-warning btn-sm me-2">\n                        <span class="bi bi-shield"></span> Block Identifier\n                    </button>\n                    <button type="button" class="btn btn-primary btn-sm">\n                        <span class="bi bi-arrow-clockwise"></span> Reset Limits\n                    </button>\n                </div>\n            `}),1e3)}(e.target.closest(".view-details-btn"))})),o.checked&&k();d.checked&&C();h()}(),window.addEventListener("beforeunload",(function(){M(),S()}))}));