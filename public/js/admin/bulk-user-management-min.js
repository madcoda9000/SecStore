class BulkUserManager{constructor(){this.selectedUsers=new Set,this.allUsers=new Map,this.isProcessing=!1,this.currentBulkConfirmResolve=null,this.currentBulkOperation=null,this.elements={selectAllCheckbox:document.getElementById("selectAllCheckbox"),bulkActionsContainer:document.getElementById("bulkActionsContainer"),selectionSummary:document.getElementById("selectionSummary"),selectionSummaryText:document.getElementById("selectionSummaryText"),selectionCount:document.getElementById("selectionCount"),bulkActionText:document.getElementById("bulkActionText"),bulkProgressModal:null,bulkResultsModal:null,confirmModal:null,progressOperation:document.getElementById("progressOperation"),bulkProgressBar:document.getElementById("bulkProgressBar"),progressStatus:document.getElementById("progressStatus"),resultsModalTitle:document.getElementById("resultsModalTitle"),successCount:document.getElementById("successCount"),skippedCount:document.getElementById("skippedCount"),failedCount:document.getElementById("failedCount"),resultsTable:document.getElementById("resultsTable"),confirmModalTitle:document.getElementById("confirmModalTitle2"),confirmModalMessage:document.getElementById("confirmModalMessage2"),confirmModalSubtext:document.getElementById("confirmModalSubtext2"),confirmModalBtnText:document.getElementById("confirmModalBtnText2"),confirmModalIcon:document.getElementById("confirmModalIcon"),confirmDeleteBtn:document.getElementById("confirmDeleteBtn2")},this.init()}init(){this.initializeModals(),this.collectUserData(),this.setupEventListeners()}initializeModals(){const e=document.getElementById("bulkProgressModal"),t=document.getElementById("bulkResultsModal"),s=document.getElementById("confirmDeleteModal2");e&&(this.elements.bulkProgressModal=new bootstrap.Modal(e)),t&&(this.elements.bulkResultsModal=new bootstrap.Modal(t)),s&&(this.elements.confirmModal=new bootstrap.Modal(s))}collectUserData(){document.querySelectorAll("tbody tr[data-user-id]").forEach((e=>{const t=parseInt(e.dataset.userId),s=e.dataset.username;e.querySelectorAll("td");this.allUsers.set(t,{id:t,username:s,element:e})}))}setupEventListeners(){document.addEventListener("click",this.handleClick.bind(this)),document.addEventListener("change",this.handleChange.bind(this));const e=document.getElementById("bulkResultsModal");e&&e.addEventListener("hidden.bs.modal",(()=>{this.elements.bulkProgressModal&&this.elements.bulkProgressModal._element.classList.contains("show")&&this.elements.bulkProgressModal.hide()}));const t=document.getElementById("confirmDeleteModal2");t&&t.addEventListener("hidden.bs.modal",(()=>{this.currentBulkConfirmResolve&&(this.currentBulkConfirmResolve(!1),this.currentBulkConfirmResolve=null,this.currentBulkOperation=null)}))}handleClick(e){const t=e.target,s=t.dataset.action||t.closest("[data-action]")?.dataset.action,n=t.dataset.bulkAction||t.closest("[data-bulk-action]")?.dataset.bulkAction,l=t.dataset.export||t.closest("[data-export]")?.dataset.export;if("toggle-select-all"!==s&&"update-selection"!==s)return n?(e.preventDefault(),void this.executeBulkAction(n)):s?(e.preventDefault(),void this.handleAction(s)):l?(e.preventDefault(),void this.handleExport(l)):void 0}handleAction(e){switch(e){case"clear-selection":this.clearSelection();break;case"refresh-user-list":this.refreshUserList();break;default:}}handleChange(e){const t=e.target,s=t.dataset.action;"toggle-select-all"===s?this.toggleSelectAll(t.checked):"update-selection"===s&&this.updateSelection()}handleExport(e){const[t,s]=e.split("-");this.exportUsers(t,s)}async executeBulkAction(e){if(0!==this.selectedUsers.size){if(!this.isProcessing){if("delete"===e){if(!await this.confirmDangerousAction("Delete Users",`Are you sure you want to delete ${this.selectedUsers.size} user${1!==this.selectedUsers.size?"s":""}?`))return}else if("mfa_enforce"===e){if(!await this.confirmDangerousAction("Enforce 2FA",`Enforce 2FA for ${this.selectedUsers.size} user${1!==this.selectedUsers.size?"s":""}?`,e))return}else if("mfa_unenforce"===e){if(!await this.confirmDangerousAction("Remove 2FA Enforcement",`Remove 2FA enforcement for ${this.selectedUsers.size} user${1!==this.selectedUsers.size?"s":""}?`,e))return}await this.processBulkOperation(e)}}else this.showAlert("No users selected","warning")}async processBulkOperation(e,t={}){this.showProgressModal(e);try{this.isProcessing=!0;const s=Array.from(this.selectedUsers),n=await this.sendBulkRequest(e,s,t);if(!n.success)throw new Error(n.message||"Operation failed");this.showResults(n),this.clearSelection()}catch(e){this.elements.bulkProgressModal&&this.elements.bulkProgressModal.hide(),this.showAlert("Operation failed: "+e.message,"danger")}finally{this.isProcessing=!1,setTimeout((()=>{this.elements.bulkProgressModal&&this.elements.bulkProgressModal._element.classList.contains("show")&&this.elements.bulkProgressModal.hide()}),500)}}toggleSelectAll(e){document.querySelectorAll(".user-select-checkbox").forEach(((t,s)=>{t.checked=e;const n=parseInt(t.value),l=t.closest("tr");e?(this.selectedUsers.add(n),l.classList.add("selected")):(this.selectedUsers.delete(n),l.classList.remove("selected"))})),this.updateUI()}updateSelection(){this.selectedUsers.clear();document.querySelectorAll(".user-select-checkbox").forEach((e=>{const t=parseInt(e.value),s=e.closest("tr");e.checked?(this.selectedUsers.add(t),s.classList.add("selected")):s.classList.remove("selected")})),this.updateSelectAllState(),this.updateUI()}updateSelectAllState(){const e=document.querySelectorAll(".user-select-checkbox").length,t=this.selectedUsers.size;this.elements.selectAllCheckbox&&(this.elements.selectAllCheckbox.checked=t===e,this.elements.selectAllCheckbox.indeterminate=t>0&&t<e)}updateUI(){const e=this.selectedUsers.size,t=e>0;this.elements.selectionCount&&(this.elements.selectionCount.textContent=e),this.elements.selectionSummaryText&&(this.elements.selectionSummaryText.textContent=`${e} user${1!==e?"s":""} selected`),this.elements.selectedUsersCount&&(this.elements.selectedUsersCount.textContent=e),t?(this.elements.bulkActionsContainer?.classList.remove("d-none"),this.elements.selectionSummary?.classList.remove("d-none")):(this.elements.bulkActionsContainer?.classList.add("d-none"),this.elements.selectionSummary?.classList.add("d-none")),this.elements.bulkActionText&&(this.elements.bulkActionText.textContent=0===e?"Bulk Actions":`${e} User${1!==e?"s":""} Selected`)}clearSelection(){this.selectedUsers.clear();document.querySelectorAll(".user-select-checkbox").forEach((e=>{e.checked=!1,e.closest("tr").classList.remove("selected")})),this.elements.selectAllCheckbox&&(this.elements.selectAllCheckbox.checked=!1,this.elements.selectAllCheckbox.indeterminate=!1),this.updateUI()}async sendBulkRequest(e,t,s={}){const n=document.getElementById("csrf_token")?.value;if(!n)throw new Error("CSRF token not found");const l=await fetch("/admin/users/bulk",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({operation:e,userIds:t,options:s,csrf_token:n})});if(!l.ok)throw new Error(`HTTP ${l.status}`);return await l.json()}showProgressModal(e){const t={delete:"Deleting Users",enable:"Enabling Users",disable:"Disabling Users",mfa_enforce:"Enforcing 2FA",mfa_unenforce:"Removing 2FA Enforcement"};this.elements.progressOperation&&(this.elements.progressOperation.textContent=t[e]||"Processing"),this.elements.bulkProgressModal&&this.elements.bulkProgressModal.show(),this.animateProgressBar()}animateProgressBar(){if(!this.elements.bulkProgressBar)return;let e=0;const t=setInterval((()=>{e+=10*Math.random(),e>90&&(e=90),this.elements.bulkProgressBar.style.width=`${e}%`,this.isProcessing||(clearInterval(t),this.elements.bulkProgressBar.style.width="100%")}),300)}showResults(e){this.elements.bulkProgressModal&&this.elements.bulkProgressModal.hide(),this.elements.successCount&&(this.elements.successCount.textContent=e.summary?.success||0),this.elements.skippedCount&&(this.elements.skippedCount.textContent=e.summary?.skipped||0),this.elements.failedCount&&(this.elements.failedCount.textContent=e.summary?.failed||0);const t=(e.summary?.failed||0)>0?'<i class="bi bi-exclamation-triangle text-warning"></i>':'<i class="bi bi-check-circle text-success"></i>';this.elements.resultsModalTitle&&(this.elements.resultsModalTitle.innerHTML=`${t} ${e.operation.charAt(0).toUpperCase()+e.operation.slice(1)} Complete`),this.generateResultsTable(e.details||[]),this.elements.bulkResultsModal&&this.elements.bulkResultsModal.show()}exportUsers(e,t){let s=`/admin/users/export?format=${e}`;if("selected"===t){if(0===this.selectedUsers.size)return void this.showAlert("No users selected","warning");s+=`&userIds=${Array.from(this.selectedUsers).join(",")}`}const n=document.createElement("a");n.href=s,n.download="",document.body.appendChild(n),n.click(),document.body.removeChild(n),this.showAlert("Export started","success")}refreshUserList(){window.location.reload()}showAlert(e,t="info"){const s=document.createElement("div");s.className=`alert alert-${t} alert-dismissible fade show position-fixed`,s.style.cssText="\n            top: 20px; right: 20px; z-index: 9999; min-width: 300px;\n        ",s.innerHTML=`\n            ${e}\n            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>\n        `,document.body.appendChild(s),setTimeout((()=>{s.parentElement&&s.remove()}),5e3)}getBulkConfirmTranslations(e,t){const s=this.selectedUsers.size,n=1!==s?"s":"",l={delete:{title:t.dataset.bulkDeleteTitle,message:t.dataset.bulkDeleteMessage,subtext:t.dataset.bulkDeleteSubtext,btnText:t.dataset.bulkDeleteBtn,btnClass:"btn-danger",icon:"bi-trash-fill text-danger"},disable:{title:t.dataset.bulkDisableTitle,message:t.dataset.bulkDisableMessage,subtext:t.dataset.bulkDisableSubtext,btnText:t.dataset.bulkDisableBtn,btnClass:"btn-warning",icon:"bi-person-x text-warning"},mfa_enforce:{title:t.dataset.bulkMfaEnforceTitle,message:t.dataset.bulkMfaEnforceMessage,subtext:t.dataset.bulkMfaEnforceSubtext,btnText:t.dataset.bulkMfaEnforceBtn,btnClass:"btn-warning",icon:"bi-shield-exclamation text-warning"},mfa_unenforce:{title:t.dataset.bulkMfaUnenforceTitle,message:t.dataset.bulkMfaUnenforceMessage,subtext:t.dataset.bulkMfaUnenforceSubtext,btnText:t.dataset.bulkMfaUnenforceBtn,btnClass:"btn-info",icon:"bi-shield-slash text-info"}},o=l[e];return o?(o.message&&(o.message=o.message.replace("{count}",s.toString()).replace("{plural}",n)),o):l.delete}updateBulkConfirmModal(e){this.elements.confirmModalTitle&&e.title&&(this.elements.confirmModalTitle.textContent=e.title),this.elements.confirmModalMessage&&e.message&&(this.elements.confirmModalMessage.textContent=e.message),this.elements.confirmModalSubtext&&e.subtext&&(this.elements.confirmModalSubtext.textContent=e.subtext),this.elements.confirmDeleteBtn&&e.btnClass&&(this.elements.confirmDeleteBtn.className=`btn ${e.btnClass}`),this.elements.confirmModalBtnText&&e.btnText&&(this.elements.confirmModalBtnText.textContent=e.btnText),this.elements.confirmModalIcon&&e.icon&&(this.elements.confirmModalIcon.className=`${e.icon} fs-1 me-3`)}confirmDangerousAction(e,t,s){return new Promise((n=>{this.currentBulkConfirmResolve=n,this.currentBulkOperation=s;const l=document.getElementById("users-messages");if(!l)return void n(confirm(`${e}\n\n${t}`));const o=this.getBulkConfirmTranslations(s,l);this.updateBulkConfirmModal(o),this.elements.confirmModal&&this.elements.confirmModal.show()}))}generateResultsTable(e){if(!e||0===e.length)return void(this.elements.resultsTable.innerHTML='<p class="text-muted">No detailed results available.</p>');const t=document.createElement("table");t.className="table table-sm table-striped",t.innerHTML=`\n        <thead>\n            <tr>\n                <th>User</th>\n                <th>Status</th>\n                <th>Details</th>\n            </tr>\n        </thead>\n        <tbody>\n            ${e.map((e=>{const t=this.getStatusBadge(e.status);return`\n                    <tr>\n                        <td>\n                            <strong>${e.username||"Unknown"}</strong>\n                            <br><small class="text-muted">ID: ${e.userId}</small>\n                        </td>\n                        <td>${t}</td>\n                        <td><small>${e.reason||"No details"}</small></td>\n                    </tr>\n                `})).join("")}\n        </tbody>\n    `,this.elements.resultsTable.innerHTML="",this.elements.resultsTable.appendChild(t)}getStatusBadge(e){return{success:'<span class="badge bg-success">Success</span>',failed:'<span class="badge bg-danger">Failed</span>',skipped:'<span class="badge bg-warning">Skipped</span>'}[e]||'<span class="badge bg-secondary">Unknown</span>'}}document.addEventListener("DOMContentLoaded",(function(){window.bulkManager=new BulkUserManager}));