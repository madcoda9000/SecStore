class BulkUserManager{constructor(){this.selectedUsers=new Set,this.allUsers=new Map,this.isProcessing=!1,this.elements={selectAllCheckbox:document.getElementById("selectAllCheckbox"),bulkActionsContainer:document.getElementById("bulkActionsContainer"),selectionSummary:document.getElementById("selectionSummary"),selectionSummaryText:document.getElementById("selectionSummaryText"),selectionCount:document.getElementById("selectionCount"),bulkActionText:document.getElementById("bulkActionText"),roleAssignmentModal:null,bulkProgressModal:null,bulkResultsModal:null,roleSelect:document.getElementById("roleSelect"),selectedUsersCount:document.getElementById("selectedUsersCount"),progressOperation:document.getElementById("progressOperation"),bulkProgressBar:document.getElementById("bulkProgressBar"),progressStatus:document.getElementById("progressStatus"),resultsModalTitle:document.getElementById("resultsModalTitle"),successCount:document.getElementById("successCount"),skippedCount:document.getElementById("skippedCount"),failedCount:document.getElementById("failedCount"),resultsTable:document.getElementById("resultsTable")},this.init()}init(){this.initializeModals(),this.collectUserData(),this.setupEventListeners(),this.loadAvailableRoles()}initializeModals(){const e=document.getElementById("roleAssignmentModal"),t=document.getElementById("bulkProgressModal"),s=document.getElementById("bulkResultsModal");e&&(this.elements.roleAssignmentModal=new bootstrap.Modal(e)),t&&(this.elements.bulkProgressModal=new bootstrap.Modal(t)),s&&(this.elements.bulkResultsModal=new bootstrap.Modal(s))}collectUserData(){document.querySelectorAll("tbody tr[data-user-id]").forEach((e=>{const t=parseInt(e.dataset.userId),s=e.dataset.username;e.querySelectorAll("td");this.allUsers.set(t,{id:t,username:s,element:e})}))}setupEventListeners(){document.addEventListener("click",this.handleClick.bind(this)),document.addEventListener("change",this.handleChange.bind(this))}handleClick(e){const t=e.target,s=t.dataset.action||t.closest("[data-action]")?.dataset.action,l=t.dataset.bulkAction||t.closest("[data-bulk-action]")?.dataset.bulkAction,n=t.dataset.export||t.closest("[data-export]")?.dataset.export;if("toggle-select-all"!==s&&"update-selection"!==s)return l?(e.preventDefault(),void this.executeBulkAction(l)):s?(e.preventDefault(),void this.handleAction(s)):n?(e.preventDefault(),void this.handleExport(n)):void 0}handleChange(e){const t=e.target,s=t.dataset.action;"toggle-select-all"===s?this.toggleSelectAll(t.checked):"update-selection"===s&&this.updateSelection()}handleChange(e){const t=e.target,s=t.dataset.action;"toggle-select-all"===s?this.toggleSelectAll(t.checked):"update-selection"===s&&this.updateSelection()}handleExport(e){const[t,s]=e.split("-");this.exportUsers(t,s)}async executeBulkAction(e){if(0!==this.selectedUsers.size){if(!this.isProcessing){if("delete"===e){if(!await this.confirmDangerousAction("Delete Users",`Are you sure you want to delete ${this.selectedUsers.size} user${1!==this.selectedUsers.size?"s":""}?`))return}await this.processBulkOperation(e)}}else this.showAlert("No users selected","warning")}async processBulkOperation(e,t={}){this.showProgressModal(e);try{this.isProcessing=!0;const s=Array.from(this.selectedUsers),l=await this.sendBulkRequest(e,s,t);if(!l.success)throw new Error(l.message||"Operation failed");this.showResults(l),this.clearSelection()}catch(e){this.showAlert("Operation failed: "+e.message,"danger")}finally{this.isProcessing=!1,this.elements.bulkProgressModal&&this.elements.bulkProgressModal.hide()}}toggleSelectAll(e){document.querySelectorAll(".user-select-checkbox").forEach((t=>{t.checked=e;const s=parseInt(t.value),l=t.closest("tr");e?(this.selectedUsers.add(s),l.classList.add("selected")):(this.selectedUsers.delete(s),l.classList.remove("selected"))})),this.updateUI()}updateSelection(){this.selectedUsers.clear();document.querySelectorAll(".user-select-checkbox").forEach((e=>{const t=parseInt(e.value),s=e.closest("tr");e.checked?(this.selectedUsers.add(t),s.classList.add("selected")):s.classList.remove("selected")})),this.updateSelectAllState(),this.updateUI()}updateSelectAllState(){const e=document.querySelectorAll(".user-select-checkbox").length,t=this.selectedUsers.size;this.elements.selectAllCheckbox&&(this.elements.selectAllCheckbox.checked=t===e,this.elements.selectAllCheckbox.indeterminate=t>0&&t<e)}updateUI(){const e=this.selectedUsers.size,t=e>0;this.elements.selectionCount&&(this.elements.selectionCount.textContent=e),this.elements.selectionSummaryText&&(this.elements.selectionSummaryText.textContent=`${e} user${1!==e?"s":""} selected`),this.elements.selectedUsersCount&&(this.elements.selectedUsersCount.textContent=e),t?(this.elements.bulkActionsContainer?.classList.remove("d-none"),this.elements.selectionSummary?.classList.remove("d-none")):(this.elements.bulkActionsContainer?.classList.add("d-none"),this.elements.selectionSummary?.classList.add("d-none")),this.elements.bulkActionText&&(this.elements.bulkActionText.textContent=0===e?"Bulk Actions":`${e} User${1!==e?"s":""} Selected`)}clearSelection(){this.selectedUsers.clear();document.querySelectorAll(".user-select-checkbox").forEach((e=>{e.checked=!1,e.closest("tr").classList.remove("selected")})),this.elements.selectAllCheckbox&&(this.elements.selectAllCheckbox.checked=!1,this.elements.selectAllCheckbox.indeterminate=!1),this.updateUI()}showRoleAssignmentModal(){0!==this.selectedUsers.size?this.elements.roleAssignmentModal&&this.elements.roleAssignmentModal.show():this.showAlert("No users selected","warning")}async confirmRoleAssignment(){const e=this.elements.roleSelect?.value;e?(this.elements.roleAssignmentModal&&this.elements.roleAssignmentModal.hide(),await this.processBulkOperation("assign_role",{role:e})):this.showAlert("Please select a role","warning")}async loadAvailableRoles(){const e=["User","Admin","Manager","Editor"];this.elements.roleSelect&&(this.elements.roleSelect.innerHTML='<option value="">Choose a role...</option>',e.forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,this.elements.roleSelect.appendChild(t)})))}async sendBulkRequest(e,t,s={}){const l=document.getElementById("csrf_token")?.value;if(!l)throw new Error("CSRF token not found");const n=await fetch("/admin/users/bulk",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({operation:e,userIds:t,options:s,csrf_token:l})});if(!n.ok)throw new Error(`HTTP ${n.status}`);return await n.json()}showProgressModal(e){const t={delete:"Deleting Users",enable:"Enabling Users",disable:"Disabling Users",assign_role:"Assigning Roles",mfa_enable:"Enabling 2FA",mfa_disable:"Disabling 2FA",mfa_enforce:"Enforcing 2FA",mfa_unenforce:"Removing 2FA Enforcement"};this.elements.progressOperation&&(this.elements.progressOperation.textContent=t[e]||"Processing"),this.elements.bulkProgressModal&&this.elements.bulkProgressModal.show(),this.animateProgressBar()}animateProgressBar(){if(!this.elements.bulkProgressBar)return;let e=0;const t=setInterval((()=>{e+=10*Math.random(),e>90&&(e=90),this.elements.bulkProgressBar.style.width=`${e}%`,this.isProcessing||(clearInterval(t),this.elements.bulkProgressBar.style.width="100%")}),300)}showResults(e){this.elements.successCount&&(this.elements.successCount.textContent=e.summary?.success||0),this.elements.skippedCount&&(this.elements.skippedCount.textContent=e.summary?.skipped||0),this.elements.failedCount&&(this.elements.failedCount.textContent=e.summary?.failed||0),this.elements.bulkResultsModal&&this.elements.bulkResultsModal.show()}exportUsers(e,t){let s=`/admin/users/export?format=${e}`;if("selected"===t){if(0===this.selectedUsers.size)return void this.showAlert("No users selected","warning");s+=`&userIds=${Array.from(this.selectedUsers).join(",")}`}const l=document.createElement("a");l.href=s,l.download="",document.body.appendChild(l),l.click(),document.body.removeChild(l),this.showAlert("Export started","success")}refreshUserList(){window.location.reload()}showAlert(e,t="info"){const s=document.createElement("div");s.className=`alert alert-${t} alert-dismissible fade show position-fixed`,s.style.cssText="\n            top: 20px; right: 20px; z-index: 9999; min-width: 300px;\n        ",s.innerHTML=`\n            ${e}\n            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>\n        `,document.body.appendChild(s),setTimeout((()=>{s.parentElement&&s.remove()}),5e3)}confirmDangerousAction(e,t){return Promise.resolve(confirm(`${e}\n\n${t}`))}}document.addEventListener("DOMContentLoaded",(function(){window.bulkManager=new BulkUserManager}));