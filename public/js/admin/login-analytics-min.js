document.addEventListener("DOMContentLoaded",(function(){const t=document.getElementById("analytics-config"),e={analyticsUrl:t?.getAttribute("data-analytics-url")||"/admin/analytics/data",refreshInterval:parseInt(t?.getAttribute("data-refresh-interval"))||3e5,autoRefresh:"true"===t?.getAttribute("data-auto-refresh"),csrfToken:t?.getAttribute("data-csrf-token")||""};let a={};if(t)try{a={heatmap:JSON.parse(t.getAttribute("data-heatmap-data")||"{}"),hourly:JSON.parse(t.getAttribute("data-hourly-data")||"[]"),weekly:JSON.parse(t.getAttribute("data-weekly-data")||"[]"),patterns:JSON.parse(t.getAttribute("data-patterns-data")||"[]")}}catch(t){a={heatmap:{},hourly:[],weekly:[],patterns:[]}}const n={heatmap:null,hourly:null,weekly:null};(function(){const t=document.getElementById("loginHeatmapChart");if(!t)return;const e=t.getContext("2d"),s=a.heatmap||null;if(!s||!s.heatmap_matrix)return;const r=i(s.heatmap_matrix);n.heatmap=new Chart(e,{type:"scatter",data:{datasets:[{label:"Login Activity",data:r,backgroundColor:function(t){return function(t,e){if(0===t)return"rgba(0, 0, 0, 0)";const a=Math.min(1,t/(.1*e));return a<.3?`rgba(59, 130, 246, ${.3+.7*a})`:a<.7?`rgba(251, 191, 36, ${.5+.5*a})`:`rgba(239, 68, 68, ${.7+.3*a})`}(t.parsed.v||0,s.total_logins)},pointRadius:function(t){const e=t.parsed.v||0;return Math.max(3,Math.min(15,2*e))}}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{type:"linear",position:"bottom",min:0,max:23,ticks:{stepSize:1,callback:function(t){return t+":00"}},title:{display:!0,text:"Hour of Day"}},y:{type:"linear",min:0,max:6,ticks:{stepSize:1,callback:function(t){return["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][t]||""}},title:{display:!0,text:"Day of Week"}}},plugins:{title:{display:!0,text:"Login Activity Heatmap (Last 30 Days)"},tooltip:{callbacks:{title:function(t){const e=t[0],a=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],n=e.parsed.x;return`${a[e.parsed.y]} ${n}:00`},label:function(t){const e=t.parsed.v||0;return`${e} login${1!==e?"s":""}`}}},legend:{display:!1}}}}),s.peak_activity&&function(t){const e=document.getElementById("heatmapInsights");if(!e)return;let a=`\n            <div class="card mt-3">\n                <div class="card-body">\n                    <h6 class="card-title">ðŸ“Š Activity Insights</h6>\n                    <p><strong>Peak Activity:</strong> ${t.peak_activity.peak_description}</p>\n                    <p><strong>Total Logins Analyzed:</strong> ${t.total_logins}</p>\n                    <p><strong>Analysis Period:</strong> Last ${t.analysis_period_days} days</p>\n                </div>\n            </div>\n        `;e.innerHTML=a}(s)})(),function(){const t=document.getElementById("hourlyDistributionChart");if(!t)return;const e=t.getContext("2d"),s=a.hourly||[];0!==s.length&&(n.hourly=new Chart(e,{type:"bar",data:{labels:s.map((t=>t.hour_label)),datasets:[{label:"Successful Logins",data:s.map((t=>t.successful_logins)),backgroundColor:"rgba(34, 197, 94, 0.7)",borderColor:"rgba(34, 197, 94, 1)",borderWidth:1},{label:"Failed Logins",data:s.map((t=>t.failed_logins)),backgroundColor:"rgba(239, 68, 68, 0.7)",borderColor:"rgba(239, 68, 68, 1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{title:{display:!0,text:"Hour of Day"}},y:{beginAtZero:!0,title:{display:!0,text:"Number of Logins"}}},plugins:{title:{display:!0,text:"Hourly Login Distribution (Last 7 Days)"},tooltip:{mode:"index",intersect:!1}}}}))}(),function(){const t=document.getElementById("weeklyTrendsChart");if(!t)return;const e=t.getContext("2d"),s=a.weekly||[];0!==s.length&&(n.weekly=new Chart(e,{type:"line",data:{labels:s.map((t=>`${t.week_start} - ${t.week_end}`)),datasets:[{label:"Successful Logins",data:s.map((t=>t.successful_logins)),borderColor:"rgba(34, 197, 94, 1)",backgroundColor:"rgba(34, 197, 94, 0.1)",tension:.1,fill:!0},{label:"Failed Logins",data:s.map((t=>t.failed_logins)),borderColor:"rgba(239, 68, 68, 1)",backgroundColor:"rgba(239, 68, 68, 0.1)",tension:.1,fill:!0},{label:"Success Rate (%)",data:s.map((t=>t.success_rate)),borderColor:"rgba(59, 130, 246, 1)",backgroundColor:"rgba(59, 130, 246, 0.1)",tension:.1,yAxisID:"y1"}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{title:{display:!0,text:"Week"}},y:{type:"linear",display:!0,position:"left",beginAtZero:!0,title:{display:!0,text:"Number of Logins"}},y1:{type:"linear",display:!0,position:"right",min:0,max:100,title:{display:!0,text:"Success Rate (%)"},grid:{drawOnChartArea:!1}}},plugins:{title:{display:!0,text:"Weekly Login Trends (Last 4 Weeks)"},tooltip:{mode:"index",intersect:!1}}}}))}(),function(){const t=document.getElementById("patternAlerts");if(!t)return;const e=a.patterns||[];if(0===e.length)return void(t.innerHTML='<div class="alert alert-success">âœ… No unusual login patterns detected</div>');let n="";e.forEach((t=>{const e="high"===t.severity?"alert-danger":"medium"===t.severity?"alert-warning":"alert-info";n+=`\n                <div class="alert ${e} d-flex align-items-center">\n                    <i class="bi bi-exclamation-triangle-fill me-2"></i>\n                    <div>\n                        <strong>${t.type.replace("_"," ").toUpperCase()}:</strong>\n                        ${t.description}\n                    </div>\n                </div>\n            `})),t.innerHTML=n}();const s=document.getElementById("refreshAnalyticsBtn");function i(t){const e=[];for(let a=0;a<=6;a++)for(let n=0;n<=23;n++){const s=t[a][n]||0;s>0&&e.push({x:n,y:a,v:s})}return e}function r(){const t=document.getElementById("refreshAnalyticsBtn");if(t){const e=t.innerHTML;t.innerHTML='<i class="bi bi-hourglass-split"></i> Refreshing...',t.disabled=!0,setTimeout((()=>{t.innerHTML=e,t.disabled=!1}),3e3)}const a={"X-Requested-With":"XMLHttpRequest"};e.csrfToken&&(a["X-CSRF-Token"]=e.csrfToken),fetch(e.analyticsUrl+"?type=heatmap&days=30",{method:"GET",headers:a}).then((t=>{if(!t.ok)throw new Error("Network response was not ok");return t.json()})).then((t=>{if(t.success&&n.heatmap){const e=i(t.data.heatmap_matrix);n.heatmap.data.datasets[0].data=e,n.heatmap.update()}})).catch((t=>{!function(t){const e=document.createElement("div");e.className="alert alert-warning alert-dismissible fade show position-fixed",e.style.cssText="top: 20px; right: 20px; z-index: 9999; min-width: 300px;",e.innerHTML=`\n            <strong>Refresh Error:</strong> ${t}\n            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>\n        `,document.body.appendChild(e),setTimeout((()=>{e.parentElement&&e.remove()}),5e3)}("Failed to refresh heatmap data")})),fetch(e.analyticsUrl+"?type=hourly&days=7",{method:"GET",headers:a}).then((t=>t.json())).then((t=>{t.success&&n.hourly&&(n.hourly.data.datasets[0].data=t.data.map((t=>t.successful_logins)),n.hourly.data.datasets[1].data=t.data.map((t=>t.failed_logins)),n.hourly.update())})).catch((t=>{})),fetch(e.analyticsUrl+"?type=weekly&weeks=4",{method:"GET",headers:a}).then((t=>t.json())).then((t=>{t.success&&n.weekly&&(n.weekly.data.datasets[0].data=t.data.map((t=>t.successful_logins)),n.weekly.data.datasets[1].data=t.data.map((t=>t.failed_logins)),n.weekly.data.datasets[2].data=t.data.map((t=>t.success_rate)),n.weekly.update())})).catch((t=>{}))}s&&s.addEventListener("click",(function(t){t.preventDefault(),r()})),e.autoRefresh&&setInterval(r,e.refreshInterval),window.loginAnalytics={charts:n,config:e,refresh:r,data:a}}));