document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("backup-codes-count"),t=document.getElementById("regenerate-backup-codes"),n=document.getElementById("backup-codes-warning"),o=document.getElementById("backup-codes-warning-text"),a=document.getElementById("backup-codes-translations"),c=new bootstrap.Modal(document.getElementById("backupCodesModal")),s=document.getElementById("modal-backup-codes-display");if(!e)return;function d(t){const c=a||{};if(0===t)e.innerHTML=`<span class="badge bg-danger">${t} ${c.getAttribute("data-none")||"codes"}</span>`,n&&o&&(o.textContent=c.getAttribute("data-none")||"No backup codes available",n.classList.remove("d-none"),n.classList.add("alert-danger"),n.classList.remove("alert-warning"));else if(t<=3){if(e.innerHTML=`<span class="badge bg-warning text-dark">${t} codes</span>`,n&&o&&c){const e=c.getAttribute("data-warning-low")||"You only have {count} backup codes left";o.textContent=e.replace("{count}",t),n.classList.remove("d-none"),n.classList.add("alert-warning"),n.classList.remove("alert-danger")}}else e.innerHTML=`<span class="badge bg-success">${t} codes</span>`,n&&n.classList.add("d-none")}fetch("/getBackupCodesCount",{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}}).then((e=>e.json())).then((t=>{t.success?d(t.count):e.innerHTML='<span class="text-danger">Error loading count</span>'})).catch((t=>{e.innerHTML='<span class="text-danger">Error loading count</span>'})),t&&t.addEventListener("click",(function(){const e=a||{},n=e.getAttribute("data-regenerate-confirm")||"Do you really want to generate new backup codes? All old codes will become invalid!";if(!confirm(n))return;t.disabled=!0;const o=t.innerHTML;t.innerHTML='<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...';const r=document.querySelector('input[name="csrf_token"]').value,i=new FormData;i.append("csrf_token",r),fetch("/regenerateBackupCodes",{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:i}).then((e=>e.json())).then((t=>{if(t.success&&t.codes){const n=t.codes.map(((e,t)=>`${String(t+1).padStart(2," ")}. ${e}`)).join("\n");if(s.textContent=n,c.show(),d(t.codes.length),"function"==typeof showToast){const t=e.getAttribute("data-regenerate-success")||"New backup codes generated successfully";showToast(t,"success","Success")}}else alert(t.message||e.getAttribute("data-regenerate-error")||"Error generating backup codes")})).catch((t=>{alert(e.getAttribute("data-regenerate-error")||"Error generating backup codes")})).finally((()=>{t.disabled=!1,t.innerHTML=o}))}));const r=document.getElementById("modal-copy-codes");r&&s&&r.addEventListener("click",(function(){const e=s.textContent;navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(e).then((()=>{u(r)})).catch((t=>{p(e,r)})):p(e,r)}));const i=document.getElementById("modal-download-codes");i&&s&&i.addEventListener("click",(function(){const e=s.textContent,t="2FA_Backup_Codes_"+(new Date).toISOString().split("T")[0]+".txt",n="2FA BACKUP CODES\nGenerated: "+(new Date).toLocaleString()+"\n=====================================\n\n"+e+"\n\n‚ö†Ô∏è Keep these codes in a secure location!\nEach code can only be used once.\n",o=new Blob([n],{type:"text/plain"}),a=window.URL.createObjectURL(o),c=document.createElement("a");c.href=a,c.download=t,document.body.appendChild(c),c.click(),document.body.removeChild(c),window.URL.revokeObjectURL(a)}));const l=document.getElementById("modal-print-codes");function u(e){const t=e.innerHTML,n=(a||{}).getAttribute("data-codes-copied")||"Copied!";e.innerHTML='<i class="bi bi-check-circle-fill"></i> '+n,e.classList.add("btn-success"),e.classList.remove("btn-outline-primary"),setTimeout((()=>{e.innerHTML=t,e.classList.remove("btn-success"),e.classList.add("btn-outline-primary")}),2e3)}function p(e,t){const n=document.createElement("textarea");if(n.value=e,n.style.position="fixed",n.style.opacity="0",document.body.appendChild(n),n.select(),n){}try{document.execCommand("copy"),u(t)}catch(e){alert("Failed to copy to clipboard. Please copy manually.")}document.body.removeChild(n)}l&&s&&l.addEventListener("click",(function(){const e=s.textContent,t=window.open("","_blank","width=600,height=400");t&&(t.document.write(`\n                    <!DOCTYPE html>\n                    <html>\n                    <head>\n                        <title>2FA Backup Codes</title>\n                        <style>\n                            body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }\n                            h1 { border-bottom: 2px solid #333; padding-bottom: 10px; }\n                            .codes { font-family: 'Courier New', monospace; font-size: 14px; background: #f5f5f5; padding: 15px; border: 1px solid #ddd; white-space: pre-wrap; }\n                            .warning { background: #fff3cd; border: 1px solid #ffc107; padding: 10px; margin-top: 20px; border-radius: 4px; }\n                        </style>\n                    </head>\n                    <body>\n                        <h1>üîê 2FA Backup Codes</h1>\n                        <p><strong>Generated:</strong> ${(new Date).toLocaleString()}</p>\n                        <div class="codes">${function(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}(e)}</div>\n                        <div class="warning">\n                            <strong>‚ö†Ô∏è Important:</strong>\n                            <ul>\n                                <li>Keep these codes in a secure location</li>\n                                <li>Each code can only be used once</li>\n                                <li>Use them when you don't have access to your authenticator device</li>\n                            </ul>\n                        </div>\n                    </body>\n                    </html>\n                `),t.document.close(),t.onload=function(){t.focus(),t.print()})}))}));